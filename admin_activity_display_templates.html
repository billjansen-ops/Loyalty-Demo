<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Display Templates - Loyalty Platform</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="theme.css">
  <style>
    .templates-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .templates-table th {
      background: #fafafa;
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
    }

    .templates-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .templates-table tr:hover {
      background: #fafafa;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-verbose {
      background: #e0f2fe;
      color: #0369a1;
    }

    .badge-efficient {
      background: #dcfce7;
      color: #166534;
    }

    .badge-active {
      background: #fef3c7;
      color: #92400e;
    }

    .btn-action {
      padding: 6px 12px;
      margin-right: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .btn-edit {
      background: #dbeafe;
      color: #1e40af;
    }

    .btn-edit:hover {
      background: #bfdbfe;
    }

    .btn-delete {
      background: #fee2e2;
      color: #991b1b;
    }

    .btn-delete:hover {
      background: #fecaca;
    }

    .btn-activate {
      background: #fef3c7;
      color: #92400e;
    }

    .btn-activate:hover {
      background: #fde68a;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div id="app" class="app-layout">
    <!-- Navigation will be inserted by lp-nav.js -->
    <nav id="main-nav"></nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Page Header -->
      <div class="page-header">
        <button onclick="window.location.href='admin.html'" style="margin-bottom: 16px; padding: 8px 16px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">
          ‚Üê Back to Admin
        </button>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h1 class="page-title" id="pageTitle">Activity Display Templates</h1>
            <p style="color: var(--text-muted);">Configure how activities display in CSR pages - verbose and efficient modes</p>
          </div>
          <button class="btn btn-primary" onclick="window.location.href='admin_activity_display_template_edit.html'">
            + Create Template
          </button>
        </div>
      </div>

      <!-- Page Content -->
      <div class="page-content">
        <!-- Filters -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
          <select id="activityTypeFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; background: white;">
            <option value="">All Activity Types</option>
          </select>
        </div>

        <div class="card">
          <table class="templates-table" id="templatesTable">
            <thead>
              <tr>
                <th>Template Name</th>
                <th>Activity Type</th>
                <th>Type</th>
                <th>Status</th>
                <th>Lines</th>
                <th style="text-align: right;">Actions</th>
              </tr>
            </thead>
            <tbody id="templatesBody">
              <tr>
                <td colspan="6" style="text-align: center; padding: 24px;">
                  Loading templates...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script src="lp-nav.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:4001';
    const TENANT_ID = 1;
    let activityTypeLabels = {};
    let allTemplates = []; // Store all templates for filtering

    async function loadActivityTypes() {
      try {
        // activity_display is now in sysparm
        const response = await fetch(`${API_BASE}/v1/sysparms/key/activity_display?tenant_id=${TENANT_ID}`);
        if (response.ok) {
          const data = await response.json();
          
          // Group details by category (activity type code)
          const typeMap = {};
          if (data.details) {
            data.details.forEach(d => {
              if (!typeMap[d.category]) {
                typeMap[d.category] = {};
              }
              typeMap[d.category][d.code] = d.value;
            });
          }
          
          const filter = document.getElementById('activityTypeFilter');
          
          // Build array of types with their labels and sort_order
          const types = [];
          for (const [code, config] of Object.entries(typeMap)) {
            types.push({
              code: code,
              label: config.label || code,
              sort_order: parseInt(config.sort_order) || 99
            });
          }
          // Sort by sort_order
          types.sort((a, b) => a.sort_order - b.sort_order);
          
          types.forEach(t => {
            // Build label map for later use
            activityTypeLabels[t.code] = t.label;
            
            // Add to filter dropdown
            const option = document.createElement('option');
            option.value = t.code;
            option.textContent = t.label;
            filter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading activity types:', error);
      }
    }

    async function loadTemplates() {
      try {
        const response = await fetch(`${API_BASE}/v1/display-templates?tenant_id=${TENANT_ID}`);
        if (!response.ok) throw new Error('Failed to load templates');
        
        allTemplates = await response.json();
        filterTemplates();
      } catch (error) {
        console.error('Error loading templates:', error);
        document.getElementById('templatesBody').innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <p>‚ùå Error loading templates</p>
              <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
            </td>
          </tr>
        `;
      }
    }

    function filterTemplates() {
      const activityTypeFilter = document.getElementById('activityTypeFilter').value;
      
      const filtered = allTemplates.filter(template => {
        if (activityTypeFilter && template.activity_type !== activityTypeFilter) return false;
        return true;
      });
      
      renderTemplates(filtered);
    }

    function renderTemplates(templates) {
      const tbody = document.getElementById('templatesBody');
      
      if (templates.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <p>üìã No templates found</p>
              <p style="font-size: 14px; margin-top: 8px;">
                ${document.getElementById('activityTypeFilter').value ? 'Try selecting a different activity type or ' : ''}
                Click "Create Template" to get started
              </p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = templates.map(template => {
        const activityTypeLabel = activityTypeLabels[template.activity_type] || template.activity_type;
        
        return `
        <tr>
          <td><strong>${template.template_name}</strong></td>
          <td>${activityTypeLabel}</td>
          <td>
            <span class="badge badge-${template.template_type === 'V' ? 'verbose' : 'efficient'}">
              ${template.template_type === 'V' ? 'Verbose' : 'Efficient'}
            </span>
          </td>
          <td>
            ${template.is_active ? '<span class="badge badge-active">Active</span>' : '‚Äî'}
          </td>
          <td>${template.line_count || 0}</td>
          <td style="text-align: right;">
            <button class="btn-action btn-edit" onclick="editTemplate(${template.template_id})">
              ‚úèÔ∏è Edit
            </button>
            ${!template.is_active ? `
              <button class="btn-action btn-activate" onclick="activateTemplate(${template.template_id}, '${template.template_type}', '${template.activity_type}')">
                ‚≠ê Set Active
              </button>
            ` : ''}
            ${!template.is_active ? `
              <button class="btn-action btn-delete" onclick="deleteTemplate(${template.template_id}, '${template.template_name}')">
                üóëÔ∏è Delete
              </button>
            ` : ''}
          </td>
        </tr>
      `;
      }).join('');
    }

    function editTemplate(templateId) {
      window.location.href = `admin_activity_display_template_edit.html?id=${templateId}`;
    }

    async function activateTemplate(templateId, templateType, activityType) {
      const activityLabel = activityTypeLabels[activityType] || activityType;
      const typeLabel = templateType === 'V' ? 'Verbose' : 'Efficient';
      
      if (!confirm(`Set this template as the active ${typeLabel} template for ${activityLabel} activities?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/v1/display-templates/${templateId}/activate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tenant_id: TENANT_ID })
        });

        if (!response.ok) throw new Error('Failed to activate template');

        alert('Template activated successfully!');
        loadTemplates(); // Reload list
      } catch (error) {
        console.error('Error activating template:', error);
        alert('Error: ' + error.message);
      }
    }

    async function deleteTemplate(templateId, templateName) {
      if (!confirm(`Delete template "${templateName}"?\n\nThis cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/v1/display-templates/${templateId}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to delete template');

        alert('Template deleted successfully!');
        loadTemplates(); // Reload list
      } catch (error) {
        console.error('Error deleting template:', error);
        alert('Error: ' + error.message);
      }
    }

    // Add filter event listener
    document.getElementById('activityTypeFilter').addEventListener('change', filterTemplates);

    // Load activity types first, then templates
    async function init() {
      await loadActivityTypes();
      await loadTemplates();
      await loadActivityTypeLabel();
    }

    // Load activity type label for page title
    async function loadActivityTypeLabel() {
      try {
        const response = await fetch(`${API_BASE}/v1/sysparms/key/activity_type_label/value?tenant_id=${TENANT_ID}`);
        if (response.ok) {
          const data = await response.json();
          const label = data.value || 'Activity';
          document.getElementById('pageTitle').textContent = `${label} Display Templates`;
        }
      } catch (e) {
        console.error('Error loading activity type label:', e);
      }
    }

    init();
  </script>
</body>
</html>
