<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edit Alias Type - Loyalty Platform</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="buttons.css">
  <style>
    /* LONGORIA scroll CSS */
    html, body { height: 100%; margin: 0; overflow: hidden; }
    .app-layout { height: 100vh !important; min-height: auto !important; display: block; }
    .main-content { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    .page-header { flex-shrink: 0; padding: 12px 20px; border-bottom: 1px solid #e5e7eb; background: white; }
    .scrollable-content { flex: 1; overflow-y: auto; padding: 16px 20px; }

    .page-title { font-size: 20px; font-weight: 600; margin: 0; color: #111827; }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .tenant-indicator {
      font-size: 12px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 4px 10px;
      border-radius: 4px;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 10px 14px;
      border-radius: 4px;
      margin-bottom: 16px;
      display: none;
    }

    .form-section {
      max-width: 700px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin: 0 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-row:last-child { margin-bottom: 0; }

    .form-row.three-col {
      grid-template-columns: 1fr 2fr auto;
    }

    label {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      padding-top: 6px;
    }

    input[type="text"], select {
      padding: 6px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
    }

    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }

    .checkbox-row label {
      padding-top: 0;
      font-weight: 400;
    }

    /* Molecule details table */
    .details-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }

    .details-table th {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 2px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .details-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: middle;
    }

    .details-table tr:hover { background: #f9fafb; }

    .details-table .col-molecule { }
    .details-table .col-required { width: 80px; text-align: center; }
    .details-table .col-key { width: 80px; text-align: center; }
    .details-table .col-actions { width: 60px; text-align: center; }

    .add-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }

    .add-row select { flex: 1; }

    .empty-details {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-style: italic;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <main class="main-content">
      <div class="page-header">
        <div class="header-row">
          <div class="header-left">
            <a href="admin_alias_composites.html" class="btn btn-secondary">‚Üê Back to Alias Types</a>
            <h1 class="page-title" id="pageTitle">üè∑Ô∏è New Alias Type</h1>
            <span class="tenant-indicator" id="tenantIndicator">Loading...</span>
          </div>
        </div>
      </div>

      <div class="scrollable-content">
        <div class="error-message" id="errorMessage"></div>

        <form id="mainForm" onsubmit="saveForm(event)">
          <div class="form-section">
            <h3 class="section-title">Alias Type Details</h3>
            
            <div class="form-row">
              <label for="compositeCode">Code *</label>
              <input type="text" id="compositeCode" name="compositeCode" required maxlength="20" 
                     placeholder="e.g., PARTNER, LEGACY, CARRIER" style="text-transform: uppercase;">
            </div>

            <div class="form-row">
              <label for="compositeName">Name *</label>
              <input type="text" id="compositeName" name="compositeName" required maxlength="100"
                     placeholder="e.g., Partner Program ID">
            </div>

            <div class="form-row">
              <label>Status</label>
              <div class="checkbox-row">
                <input type="checkbox" id="isActive" name="isActive" checked>
                <label for="isActive">Active</label>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3 class="section-title">External Source Molecules</h3>
            <p class="help-text" style="margin-top: -8px; margin-bottom: 12px;">
              Define which molecule types can identify this alias. CSR picks ONE when adding an alias to a member.
              For example: carrier (American, United) OR partner (Marriott, Hertz). Leave empty for simple legacy numbers.
            </p>

            <table class="details-table">
              <thead>
                <tr>
                  <th class="col-molecule">Available Source Types</th>
                  <th class="col-actions"></th>
                </tr>
              </thead>
              <tbody id="detailsBody">
                <tr><td colspan="4" class="empty-details">No molecules added</td></tr>
              </tbody>
            </table>

            <div class="add-row">
              <select id="moleculeSelect">
                <option value="">-- Select molecule to add --</option>
              </select>
              <button type="button" class="btn btn-secondary" onclick="addMolecule()">+ Add</button>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Alias Type</button>
            <a href="admin_alias_composites.html" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = 'http://127.0.0.1:4001';
    let tenantId = sessionStorage.getItem('tenant_id') || '1';
    let tenantName = sessionStorage.getItem('tenant_name') || 'Delta';
    
    const urlParams = new URLSearchParams(window.location.search);
    const editLink = urlParams.get('link');
    const isEditMode = !!editLink;

    let details = []; // { molecule_id, molecule_key, molecule_label, is_required, is_key, sort_order }
    let availableMolecules = [];

    document.getElementById('tenantIndicator').textContent = tenantName;

    if (isEditMode) {
      document.getElementById('pageTitle').textContent = 'üè∑Ô∏è Edit Alias Type';
    }

    function showError(msg) {
      const el = document.getElementById('errorMessage');
      el.textContent = msg;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth' });
    }

    function hideError() {
      document.getElementById('errorMessage').style.display = 'none';
    }

    async function loadMolecules() {
      try {
        // Load molecules that could be used for aliases (typically lookups like partner, carrier)
        const response = await fetch(`${API_BASE}/v1/molecules?tenant_id=${tenantId}`);
        if (!response.ok) throw new Error('Failed to load molecules');
        
        const data = await response.json();
        // Filter to lookup-type molecules that make sense for aliases
        availableMolecules = data.filter(m => 
          m.value_kind === 'external_list' || m.value_kind === 'lookup'
        );
        
        updateMoleculeDropdown();
      } catch (error) {
        console.error('Error loading molecules:', error);
      }
    }

    function updateMoleculeDropdown() {
      const select = document.getElementById('moleculeSelect');
      const usedIds = new Set(details.map(d => d.molecule_id));
      
      // Filter out already-used molecules
      const available = availableMolecules.filter(m => !usedIds.has(m.molecule_id));
      
      select.innerHTML = '<option value="">-- Select molecule to add --</option>' +
        available.map(m => `<option value="${m.molecule_id}" data-key="${m.molecule_key}" data-label="${escapeHtml(m.molecule_label || m.molecule_key)}">${escapeHtml(m.molecule_label || m.molecule_key)} (${m.molecule_key})</option>`).join('');
    }

    function renderDetails() {
      const tbody = document.getElementById('detailsBody');
      
      if (details.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2" class="empty-details">No source types defined - aliases will be simple numbers without external source</td></tr>';
        return;
      }

      tbody.innerHTML = details.map((d, idx) => `
        <tr>
          <td class="col-molecule">${escapeHtml(d.molecule_label || d.molecule_key)}</td>
          <td class="col-actions" style="text-align: center; width: 60px;">
            <button type="button" class="btn btn-secondary btn-sm" onclick="removeDetail(${idx})">‚úï</button>
          </td>
        </tr>
      `).join('');
    }

    function addMolecule() {
      const select = document.getElementById('moleculeSelect');
      const option = select.selectedOptions[0];
      
      if (!option || !option.value) {
        alert('Please select a molecule');
        return;
      }

      details.push({
        molecule_id: parseInt(option.value),
        molecule_key: option.dataset.key,
        molecule_label: option.dataset.label,
        sort_order: details.length + 1
      });

      renderDetails();
      updateMoleculeDropdown();
      select.value = '';
    }

    function removeDetail(idx) {
      details.splice(idx, 1);
      // Renumber sort_order
      details.forEach((d, i) => d.sort_order = i + 1);
      renderDetails();
      updateMoleculeDropdown();
    }

    async function loadData() {
      if (!isEditMode) return;

      try {
        const response = await fetch(`${API_BASE}/v1/alias-composites/${editLink}?tenant_id=${tenantId}`);
        if (!response.ok) throw new Error('Failed to load alias type');
        
        const data = await response.json();
        
        document.getElementById('compositeCode').value = data.composite_code || '';
        document.getElementById('compositeName').value = data.composite_name || '';
        document.getElementById('isActive').checked = data.is_active !== false;

        // Load details
        if (data.details && data.details.length > 0) {
          details = data.details.map(d => ({
            molecule_id: d.molecule_id,
            molecule_key: d.molecule_key,
            molecule_label: d.molecule_label || d.molecule_key,
            is_required: d.is_required || false,
            is_key: d.is_key || false,
            sort_order: d.sort_order || 1
          }));
        }

        renderDetails();
        updateMoleculeDropdown();
      } catch (error) {
        console.error('Error:', error);
        showError('Failed to load alias type: ' + error.message);
      }
    }

    async function saveForm(event) {
      event.preventDefault();
      hideError();

      const code = document.getElementById('compositeCode').value.trim().toUpperCase();
      const name = document.getElementById('compositeName').value.trim();
      const isActive = document.getElementById('isActive').checked;

      if (!code || !name) {
        showError('Code and Name are required');
        return;
      }

      const payload = {
        tenant_id: parseInt(tenantId),
        composite_code: code,
        composite_name: name,
        is_active: isActive,
        details: details.map(d => ({
          molecule_id: d.molecule_id,
          is_required: d.is_required,
          is_key: d.is_key,
          sort_order: d.sort_order
        }))
      };

      try {
        const url = isEditMode 
          ? `${API_BASE}/v1/alias-composites/${editLink}`
          : `${API_BASE}/v1/alias-composites`;
        
        const response = await fetch(url, {
          method: isEditMode ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Save failed');
        }

        window.location.href = 'admin_alias_composites.html';
      } catch (error) {
        console.error('Error:', error);
        showError('Save failed: ' + error.message);
      }
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    // Initialize
    loadMolecules().then(() => loadData());
  </script>
</body>
</html>
