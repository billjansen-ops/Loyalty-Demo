<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Member Profile - CSR Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="theme.css">
  <style>
    /* LONGORIA viewport fix */
    html, body { height: 100%; overflow: hidden; }
    .app-layout { height: 100vh !important; min-height: auto !important; }
    .main-content { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .page-content { flex: 1; overflow-y: auto; padding: 8px 16px; }

    .form-container {
      max-width: 800px;
    }

    .form-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 6px;
      margin-bottom: 6px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 0 0 4px 0;
      padding: 3px 8px;
      background: #f9fafb;
      border-radius: 4px;
      color: #1f2937;
    }

    .form-row {
      display: grid;
      gap: 8px;
      margin-bottom: 4px;
      padding: 0 8px;
    }

    .form-row.two-col { grid-template-columns: 1fr 1fr; }
    .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .form-row.four-col { grid-template-columns: 1fr 1fr 1fr 1fr; }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 11px;
      color: #374151;
    }

    label .required { color: #dc2626; }

    input, select, textarea {
      padding: 5px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    input[readonly] {
      background: #f9fafb;
      color: #6b7280;
    }

    .form-actions {
      flex-shrink: 0;
      display: flex;
      gap: 12px;
      padding: 8px 16px;
      background: white;
      border-top: 1px solid #e5e7eb;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    .btn-back {
      margin-right: auto;
    }

    .no-member {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
    }

    .no-member-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">Loyalty Platform CSR</div>
      <nav id="nav-container"></nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Member Header -->
      <div id="member-header-container"></div>

      <!-- Page Content -->
      <div class="page-content">
        <div id="noMemberMessage" class="no-member" style="display: none;">
          <div class="no-member-icon">üë§</div>
          <h2 style="margin: 0 0 8px 0;">No Member Selected</h2>
          <p style="margin: 0 0 16px 0; color: #6b7280;">Please select a member from the search page.</p>
          <a href="csr.html" class="btn btn-primary">Go to Search</a>
        </div>

        <div id="profileForm" class="form-container" style="display: none;">
          <!-- Account Information -->
          <div id="accountInfoSection" class="form-section">
            <h2 class="section-title">Account Information</h2>
            
            <div class="form-row three-col">
              <div class="form-group">
                <label for="membership_number">Membership Number</label>
                <input type="text" id="membership_number" readonly>
              </div>
              <div class="form-group">
                <label for="member_id">Member ID (Internal)</label>
                <input type="text" id="member_id" readonly>
              </div>
              <div class="form-group">
                <label for="status">Status</label>
                <select id="status">
                  <option value="true">Active</option>
                  <option value="false">Inactive</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Personal Information -->
          <div class="form-section">
            <h2 class="section-title">Personal Information</h2>
            
            <div class="form-row" style="grid-template-columns: 1fr 60px 1fr;">
              <div class="form-group">
                <label for="fname">First Name <span class="required">*</span></label>
                <input type="text" id="fname" required>
              </div>
              <div class="form-group">
                <label for="middle_initial">MI</label>
                <input type="text" id="middle_initial" maxlength="1" style="text-transform: uppercase; text-align: center;">
              </div>
              <div class="form-group">
                <label for="lname">Last Name <span class="required">*</span></label>
                <input type="text" id="lname" required>
              </div>
            </div>

            <div class="form-row" style="grid-template-columns: 1fr 150px;">
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email">
              </div>
              <div class="form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone">
              </div>
            </div>
          </div>

          <!-- Address Information -->
          <div class="form-section">
            <h2 class="section-title">Address</h2>
            
            <div class="form-row two-col">
              <div class="form-group">
                <label for="address1">Street Address</label>
                <input type="text" id="address1">
              </div>
              <div class="form-group">
                <label for="address2">Address Line 2</label>
                <input type="text" id="address2">
              </div>
            </div>

            <div class="form-row" style="grid-template-columns: 2fr 1fr 120px;">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city">
              </div>
              <div class="form-group">
                <label for="state">State</label>
                <select id="state">
                  <option value="">-- Select --</option>
                </select>
              </div>
              <div class="form-group">
                <label for="zip">ZIP</label>
                <div style="display: flex; gap: 4px; align-items: center;">
                  <input type="text" id="zip" maxlength="5" placeholder="12345" style="width: 60px;">
                  <span style="color: #9ca3af;">-</span>
                  <input type="text" id="zip_plus4" maxlength="4" placeholder="6789" style="width: 50px;">
                </div>
              </div>
            </div>
          </div>

          <!-- Additional Information (Molecule-based) -->
          <div id="moleculeSection" class="form-section" style="display: none;">
            <h2 class="section-title">Additional Information</h2>
            <div id="moleculeFields"></div>
          </div>
        </div>
      </div>

      <!-- Fixed Action Buttons -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary btn-back" onclick="window.history.back()">‚Üê Back</button>
        <button type="button" id="cancelBtn" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
        <button type="button" id="saveBtn" class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
      </div>
    </main>
  </div>

  <script src="lp-nav.js"></script>
  <script src="member-header.js"></script>
  <script src="template-form-renderer.js"></script>
  <script>
    const API_BASE = 'http://127.0.0.1:4001';
    let originalData = {};
    let moleculeRenderer = null;
    let originalMoleculeValues = {};
    
    // Inject template form styles
    const styleTag = document.createElement('style');
    styleTag.textContent = TemplateFormRenderer.getStyles();
    document.head.appendChild(styleTag);

    // Unsquish: convert 5-byte CHAR link to numeric ID for display
    function unsquish(buffer) {
      if (!buffer) return '';
      let result = 0;
      for (let i = 0; i < buffer.length; i++) {
        result = result * 127 + (buffer.charCodeAt(i) - 1);
      }
      return result;
    }

    // Get member ID and mode from URL
    const url = new URL(location.href);
    const memberId = url.searchParams.get('memberId');
    const mode = url.searchParams.get('mode');
    const isEnrollMode = mode === 'enroll';

    let reservedMembershipNumber = null;

    if (isEnrollMode) {
      // Enrollment mode - new member
      document.getElementById('profileForm').style.display = 'block';
      document.getElementById('profileForm').querySelector('h1').textContent = 'Enroll New Member';
      document.getElementById('saveBtn').textContent = 'Enroll Member';
      document.getElementById('saveBtn').onclick = enrollMember;
      document.getElementById('cancelBtn').style.display = 'none';
      
      // Hide member header for new enrollments
      const headerContainer = document.getElementById('member-header-container');
      if (headerContainer) headerContainer.style.display = 'none';
      
      // Set up Account Info section for enrollment
      document.getElementById('member_id').closest('.form-group').style.display = 'none';
      document.getElementById('status').closest('.form-group').style.display = 'none';
      document.getElementById('membership_number').readOnly = true;
      
      // Reserve the next membership number (async)
      (async () => {
        const tenantId = sessionStorage.getItem('tenant_id') || '1';
        try {
          const response = await fetch(`${API_BASE}/v1/member/next-number?tenant_id=${tenantId}`);
          if (response.ok) {
            const data = await response.json();
            reservedMembershipNumber = data.membership_number;
            document.getElementById('membership_number').value = reservedMembershipNumber;
          } else {
            console.error('Failed to get membership number');
            document.getElementById('membership_number').value = 'Error - try again';
          }
        } catch (err) {
          console.error('Error getting membership number:', err);
          document.getElementById('membership_number').value = 'Error - try again';
        }
      })();
      
      // Load states dropdown
      loadStates();
    } else if (!memberId) {
      document.getElementById('noMemberMessage').style.display = 'block';
    } else {
      document.getElementById('profileForm').style.display = 'block';
      loadProfile();
    }

    async function enrollMember() {
      if (!reservedMembershipNumber) {
        alert('No membership number reserved. Please refresh the page.');
        return;
      }

      const data = {
        membership_number: reservedMembershipNumber,
        fname: document.getElementById('fname').value.trim(),
        lname: document.getElementById('lname').value.trim(),
        middle_initial: document.getElementById('middle_initial').value.trim() || null,
        email: document.getElementById('email').value.trim() || null,
        phone: document.getElementById('phone').value.trim() || null,
        address1: document.getElementById('address1').value.trim() || null,
        address2: document.getElementById('address2').value.trim() || null,
        city: document.getElementById('city').value.trim() || null,
        state: document.getElementById('state').value || null,
        zip: document.getElementById('zip').value.trim() || null,
        zip_plus4: document.getElementById('zip_plus4').value.trim() || null,
        tenant_id: sessionStorage.getItem('tenant_id') || '1'
      };

      if (!data.fname || !data.lname) {
        alert('First Name and Last Name are required');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/v1/member?tenant_id=${data.tenant_id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to enroll member');
        }

        const result = await response.json();
        alert(`Member enrolled successfully!\n\nMembership Number: ${result.member.membership_number}\nName: ${data.fname} ${data.lname}`);
        
        // Navigate to the new member's activity page
        window.location.href = `activity.html?memberId=${result.member.membership_number}`;
      } catch (error) {
        console.error('Error enrolling member:', error);
        alert('Error enrolling member: ' + error.message);
      }
    }

    async function loadProfile() {
      try {
        // Initialize member header
        MemberHeader.init('member-header-container');
        await MemberHeader.load(memberId, API_BASE);

        // Load states for dropdown
        await loadStates();

        // Load member profile data
        const tenantId = sessionStorage.getItem('tenant_id') || '1';
        const response = await fetch(`${API_BASE}/v1/member/${encodeURIComponent(memberId)}/profile?tenant_id=${tenantId}`);
        
        if (!response.ok) {
          throw new Error('Failed to load profile');
        }

        const profile = await response.json();
        originalData = JSON.parse(JSON.stringify(profile)); // Deep copy for cancel
        await displayProfile(profile);
        
        // Load molecule fields
        await loadMoleculeFields(tenantId);
      } catch (error) {
        console.error('Error loading profile:', error);
        alert('Error loading member profile: ' + error.message);
      }
    }

    async function loadStates() {
      try {
        const tenantId = sessionStorage.getItem('tenant_id') || '1';
        const response = await fetch(`${API_BASE}/v1/sysparms/key/state?tenant_id=${tenantId}`);
        
        if (!response.ok) {
          throw new Error('Failed to load states');
        }

        const data = await response.json();
        const stateDropdown = document.getElementById('state');
        
        // Clear existing options except the first one
        stateDropdown.innerHTML = '<option value="">-- Select --</option>';
        
        // Add state options showing "MN Minnesota" format
        // state sysparm has category=state_code, value=state_name
        if (data.details && data.details.length > 0) {
          data.details.forEach(state => {
            const option = document.createElement('option');
            option.value = state.category; // state code (e.g., "MN")
            option.textContent = `${state.category} ${state.value}`; // "MN Minnesota"
            stateDropdown.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading states:', error);
        // Continue even if states fail to load
      }
    }

    async function displayProfile(profile) {
      // Account Information
      document.getElementById('membership_number').value = profile.membership_number || '';
      document.getElementById('member_id').value = profile.link ? unsquish(profile.link) : '';
      document.getElementById('status').value = profile.is_active !== false ? 'true' : 'false';

      // Personal Information
      document.getElementById('fname').value = profile.fname || '';
      document.getElementById('middle_initial').value = profile.middle_initial || '';
      document.getElementById('lname').value = profile.lname || '';
      document.getElementById('email').value = profile.email || '';
      document.getElementById('phone').value = profile.phone || '';

      // Address Information
      document.getElementById('address1').value = profile.address1 || '';
      document.getElementById('address2').value = profile.address2 || '';
      document.getElementById('city').value = profile.city || '';
      document.getElementById('state').value = profile.state || ''; // Set code directly (e.g., "MN")
      document.getElementById('zip').value = profile.zip || '';
      document.getElementById('zip_plus4').value = profile.zip_plus4 || '';
    }
    
    async function loadMoleculeFields(tenantId) {
      try {
        moleculeRenderer = new TemplateFormRenderer(API_BASE, tenantId);
        const loaded = await moleculeRenderer.loadTemplateByActivityType('M');
        
        if (loaded && moleculeRenderer.template?.fields?.length > 0) {
          // Show molecule section
          document.getElementById('moleculeSection').style.display = 'block';
          
          // Render the form fields (no activity date, no base miles)
          const container = document.getElementById('moleculeFields');
          container.innerHTML = moleculeRenderer.renderHTML({ 
            includeActivityDate: false, 
            includeBaseMiles: false,
            cssClass: 'template-form molecule-form'
          });
          
          // Initialize fields (populate dropdowns, etc.)
          await moleculeRenderer.initializeFields();
          
          // Load existing values
          const response = await fetch(`${API_BASE}/v1/member/${encodeURIComponent(memberId)}/molecules?tenant_id=${tenantId}`);
          if (response.ok) {
            const data = await response.json();
            if (data.values) {
              originalMoleculeValues = JSON.parse(JSON.stringify(data.values));
              await moleculeRenderer.setFormData(data.values);
            }
          }
        }
      } catch (error) {
        console.warn('Could not load molecule fields:', error);
      }
    }

    function cancelEdit() {
      if (confirm('Discard all changes?')) {
        displayProfile(originalData);
        // Also reset molecule values
        if (moleculeRenderer) {
          moleculeRenderer.setFormData(originalMoleculeValues);
        }
      }
    }

    async function saveProfile() {
      const data = {
        membership_number: document.getElementById('membership_number').value.trim() || null,
        fname: document.getElementById('fname').value.trim(),
        lname: document.getElementById('lname').value.trim(),
        middle_initial: document.getElementById('middle_initial').value.trim() || null,
        email: document.getElementById('email').value.trim() || null,
        phone: document.getElementById('phone').value.trim() || null,
        address1: document.getElementById('address1').value.trim() || null,
        address2: document.getElementById('address2').value.trim() || null,
        city: document.getElementById('city').value.trim() || null,
        state: document.getElementById('state').value || null, // Already a code (e.g., "MN")
        zip: document.getElementById('zip').value.trim() || null,
        zip_plus4: document.getElementById('zip_plus4').value.trim() || null,
        is_active: document.getElementById('status').value === 'true'
      };

      if (!data.fname || !data.lname) {
        alert('First Name and Last Name are required');
        return;
      }

      try {
        const tenantId = sessionStorage.getItem('tenant_id') || '1';
        
        // Save base profile
        const response = await fetch(`${API_BASE}/v1/member/${encodeURIComponent(memberId)}/profile?tenant_id=${tenantId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to save profile');
        }

        // Save molecule values if renderer is active
        if (moleculeRenderer) {
          const moleculeData = moleculeRenderer.getFormData();
          // Filter out non-molecule fields like activity_date
          const molecules = {};
          for (const [key, value] of Object.entries(moleculeData)) {
            if (!['activity_date', 'base_points', 'member_id'].includes(key)) {
              molecules[key] = value;
            }
          }
          
          if (Object.keys(molecules).length > 0) {
            const molResponse = await fetch(`${API_BASE}/v1/member/${encodeURIComponent(memberId)}/molecules?tenant_id=${tenantId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ molecules })
            });
            
            if (!molResponse.ok) {
              const error = await molResponse.json();
              throw new Error(error.error || 'Failed to save additional information');
            }
            
            // Update original values
            originalMoleculeValues = JSON.parse(JSON.stringify(molecules));
          }
        }

        alert('Profile saved successfully!');
        originalData = JSON.parse(JSON.stringify(data));
        
        // Reload member header to show updated name
        await MemberHeader.load(memberId, API_BASE);
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error saving profile: ' + error.message);
      }
    }
  </script>
</body>
</html>
