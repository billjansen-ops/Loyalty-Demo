<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Member Activity</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --shadow:0 8px 28px rgba(16,24,40,.06); --pill:#f3f4f6;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .titlebar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
  .title{font-size:32px;font-weight:800;letter-spacing:.2px;margin:2px 0}
  .search{display:flex;gap:10px;align-items:center}
  input[type="text"]{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;min-width:260px}
  button{padding:10px 14px;border-radius:10px;border:0;background:#111;color:#fff;cursor:pointer}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .balances{padding:18px 22px;margin-bottom:22px}
  .h2{font-size:20px;font-weight:800;margin-bottom:10px}
  .pills{display:flex;gap:14px;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:10px;background:var(--pill);border:1px solid var(--line);padding:10px 14px;border-radius:999px;font-weight:700}
  .section{margin-bottom:24px}
  .section .head{font-size:20px;font-weight:800;padding:16px 18px;border-bottom:1px solid var(--line)}
  .table{width:100%;border-collapse:separate;border-spacing:0;border-radius:calc(var(--radius) - 6px);overflow:hidden}
  .row{display:grid;grid-template-columns:160px 220px 1fr 140px 110px;align-items:center;padding:16px 18px;border-top:1px solid var(--line);gap:14px}
  .row:first-child{border-top:0}
  .date{color:var(--ink);font-weight:600}
  .type{display:flex;align-items:center;gap:10px;font-weight:700}
  .type .ico{font-size:18px}
  .details{color:var(--ink)}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .miles{font-weight:800;text-align:right;font-variant-numeric:tabular-nums}
  .more{color:var(--muted);font-size:13px;display:flex;justify-content:flex-end;align-items:center;gap:6px}
  .chev{display:inline-block;transform:rotate(0deg);transition:transform .15s ease}
  .chev.open{transform:rotate(90deg)}
  .expand{display:none;background:#fafafa;border-top:1px solid var(--line)}
  .expand.open{display:block}
  .xbody{padding:12px 18px;color:#111}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto}
  .foot{color:var(--muted);font-size:12px;padding:10px 2px}
</style>
</head>
<body>
<div class="wrap">
  <div class="titlebar">
    <div class="title">Member Activity</div>
    <div class="search">
      <input id="memberInput" type="text" placeholder="Member ID">
      <button id="searchBtn">Search</button>
    </div>
  </div>

  <div class="card balances">
    <div class="h2">Balances</div>
    <div class="pills">
      <div class="pill">Base Miles <span id="baseMiles" class="muted">0</span></div>
      <div class="pill">Tier Credits <span id="tierCredits" class="muted">0</span></div>
    </div>
  </div>

  <div class="card section">
    <div class="head">Recent Activity</div>
    <div id="list" class="table"></div>
    <div id="note" class="foot"></div>
  </div>

  <div class="foot small" id="buildInfo"></div>
</div>

<script>
const API='http://127.0.0.1:4001/v1/activities?limit=50';
const list = document.getElementById('list');
const note = document.getElementById('note');
const baseMilesEl = document.getElementById('baseMiles');
const tierEl = document.getElementById('tierCredits');
const memberInput = document.getElementById('memberInput');
const searchBtn = document.getElementById('searchBtn');
document.getElementById('buildInfo').textContent = 'LP12-restore+header-expand â€” ' + new Date().toISOString();

function fmtDate(d){
  try{ const x=new Date(d); if(isNaN(x)) return d||''; return x.toLocaleDateString(); }
  catch(_){ return d||'';}
}
function n(x){ if(x==null) return ''; return Number(x).toLocaleString(); }

function iconFor(kind, sub){
  const k=(kind||'').toLowerCase(); const s=(sub||'').toLowerCase();
  if(k.includes('promotion')) return 'ðŸŽ';
  if(k.includes('adjust')) return 'ðŸ§¾';
  if(k.includes('partner')) return 'ðŸ¤';
  // heuristic: accrual base => Flight
  if(k.includes('accrual') && (s.includes('base') || s==='')) return 'âœˆï¸';
  if(k.includes('flight')) return 'âœˆï¸';
  return 'â€¢';
}

function labelFor(kind, sub){
  const k=(kind||'').toLowerCase(); const s=(sub||'').toLowerCase();
  if(k.includes('promotion')) return 'Promotion';
  if(k.includes('adjust')) return 'Adjustment';
  if(k.includes('partner')) return 'Partner';
  if(k.includes('flight')) return 'Flight';
  if(k.includes('accrual') && (s.includes('base') || s==='')) return 'Flight';
  return (kind||'Activity');
}

function composeDetails(a){
  // Friendly one-line detail if present; fall back to subtype/notes
  if(a.note) return a.note;
  if(a.details) return a.details;
  const bits=[];
  if(a.subtype) bits.push(a.subtype);
  if(a.point_type) bits.push(a.point_type);
  return bits.join(' â€¢ ');
}

function detailBlock(a){
  const showKeys=['activity_id','member_id','point_type','point_amount','kind','subtype','activity_date','created_at','adjustment_code'];
  const obj={}; showKeys.forEach(k=>{ if(a[k]!==undefined) obj[k]=a[k]; });
  const json=JSON.stringify(obj,null,2);
  return `<div class="xbody">
    <div class="code">${json.replace(/</g,'&lt;')}</div>
  </div>`;
}

function rowHTML(a, idx){
  const ico = iconFor(a.kind, a.subtype);
  const typeName = labelFor(a.kind, a.subtype);
  const details = composeDetails(a);
  const mid = a.member_id ? String(a.member_id) : '';
  return `<div class="row" data-i="${idx}">
    <div class="date">${fmtDate(a.activity_date)}</div>
    <div class="type"><span class="ico">${ico}</span>${typeName}</div>
    <div class="details">
      <div>${details || ''}</div>
      <div class="muted small">${a.point_type || ''}${mid? ' â€¢ Member '+mid : ''}</div>
    </div>
    <div class="miles">${n(a.point_amount)}</div>
    <div class="more"><span class="chev" id="chev-${idx}">â–¸</span> <span>More Info</span></div>
  </div>
  <div class="expand" id="exp-${idx}">${detailBlock(a)}</div>`;
}

function wireExpandHandlers(){
  document.querySelectorAll('.row').forEach(r=>{
    r.addEventListener('click',()=>{
      const i=r.getAttribute('data-i');
      const exp=document.getElementById('exp-'+i);
      const chev=document.getElementById('chev-'+i);
      const open=exp.classList.toggle('open');
      chev.classList.toggle('open',open);
    });
  });
}

function render(arr, source){
  // Optional member filter
  const memberFilter = memberInput.value.trim();
  let data = arr;
  if(memberFilter){
    data = arr.filter(x => String(x.member_id||'')===memberFilter);
  }

  if(!data.length){
    list.innerHTML='';
    note.textContent = source==='api' ? 'No recent activity.' : 'Showing sample data (API unavailable).';
    baseMilesEl.textContent='0'; tierEl.textContent='0';
    return;
  }
  // Totals (from filtered set)
  const base = data.filter(x => (x.point_type||'').toLowerCase().includes('mile'))
                  .reduce((s,x)=>s+(Number(x.point_amount)||0),0);
  baseMilesEl.textContent = base.toLocaleString();
  const tier = data.filter(x => (x.point_type||'').toLowerCase().includes('tier'))
                  .reduce((s,x)=>s+(Number(x.point_amount)||0),0);
  tierEl.textContent = tier.toLocaleString();

  list.innerHTML = data.map(rowHTML).join('');
  note.textContent = source==='api' ? '' : 'Showing sample data (API unavailable).';
  wireExpandHandlers();

  // If input empty, seed with first member ID for convenience
  if(!memberFilter && data[0]?.member_id){
    memberInput.value = String(data[0].member_id);
  }
}

async function load(){
  try{
    const res = await fetch(API);
    const text = await res.text();
    if(!res.ok) throw new Error('HTTP '+res.status+' '+res.statusText+': '+text);
    const data = JSON.parse(text);
    const arr = (data && data.activities) ? data.activities : [];
    render(arr,'api');
  }catch(e){
    // Fallback sample rows matching the approved look
    const sample=[
      {activity_date:'2025-10-23', kind:'Flight', subtype:'base', point_type:'miles', point_amount:1508, member_id:2153442807, note:'DL â€” MSP â†’ LGA â€¢ Flight 104 â€¢ Class F', activity_id:10, created_at:'2025-10-24T21:02:00-05:00'},
      {activity_date:'2025-09-01', kind:'Partner', point_type:'miles', point_amount:1250, member_id:2153442807, note:'Marriott â€” Stay Credit â€¢ 3 nights â€¢ NYC', activity_id:8, created_at:'2025-10-24T15:55:50-05:00'},
      {activity_date:'2025-08-17', kind:'Adjustment', point_type:'miles', point_amount:500, member_id:2153442807, note:'Manual Adjustment â€” Policy Exception', activity_id:7, created_at:'2025-10-24T15:55:50-05:00'},
      {activity_date:'2025-07-31', kind:'Promotion', point_type:'miles', point_amount:750, member_id:2153442807, note:'Summer Sprint â€” Qualifying Activity â€¢ Cycle 1 â€¢ Progress 2/3', activity_id:9, created_at:'2025-10-24T15:55:50-05:00'}
    ];
    render(sample,'sample');
  }
}

searchBtn.addEventListener('click', load);
window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
