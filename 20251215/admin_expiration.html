<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Expiration Rules - Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="admin-layout.css">
  <link rel="stylesheet" href="buttons.css">
  <style>
    .data-table td {
      padding: 8px 12px;
    }
    .data-table th {
      padding: 10px 12px;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">Loyalty Platform</div>
      <nav class="nav" id="nav-container"></nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Page Header -->
      <div class="admin-page-header" data-admin-back>
        <div>
          <h1 class="admin-page-title"><span id="currencyLabel">Point</span> Expiration Rules</h1>
          <p class="admin-page-description">‚è∞ Define when <span class="currency-label-lower">points</span> expire based on activity date ranges</p>
        </div>
      </div>

      <!-- Page Content -->
      <div class="admin-page-content">
        <section class="admin-section">
          <div class="admin-scrollable-container">
            <div class="table-header">
              <h2>Expiration Rules</h2>
              <a href="admin_expiration_edit.html" class="btn btn-add">+ Add New Rule</a>
            </div>
            
            <table class="data-table">
              <thead>
                <tr>
                  <th style="width: 120px;">Rule Key</th>
                  <th style="width: 120px;">Start Date</th>
                  <th style="width: 120px;">End Date</th>
                  <th style="width: 120px;">Expiration Date</th>
                  <th>Description</th>
                  <th style="width: 160px;">Actions</th>
                </tr>
              </thead>
              <tbody id="rulesBody">
                <tr><td colspan="6" class="empty-state">Loading expiration rules...</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="lp-nav.js"></script>
  <script src="admin-back-button.js"></script>
  <script>
    const API_BASE = window.LP_STATE?.apiBase || 'http://127.0.0.1:4001';
    const tenantId = new URLSearchParams(window.location.search).get('tenant_id') || 1;
    
    async function loadRules() {
      try {
        const response = await fetch(`${API_BASE}/v1/expiration-rules?tenant_id=${tenantId}`);
        if (!response.ok) throw new Error('Failed to load expiration rules');
        
        const rules = await response.json();
        const tbody = document.getElementById('rulesBody');
        
        if (!rules || rules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No expiration rules found. Click "Add New Rule" to create one.</td></tr>';
          return;
        }
        
        tbody.innerHTML = rules.map(rule => {
          const startDate = new Date(rule.start_date).toLocaleDateString();
          const endDate = new Date(rule.end_date).toLocaleDateString();
          const expirationDate = new Date(rule.expiration_date).toLocaleDateString();
          
          return `
            <tr>
              <td class="code-cell">${rule.rule_key}</td>
              <td>${startDate}</td>
              <td>${endDate}</td>
              <td>${expirationDate}</td>
              <td>${rule.description || '-'}</td>
              <td>
                <button class="btn btn-edit" onclick="editRule('${rule.rule_key}')">‚úèÔ∏è Edit</button>
                <button class="btn btn-delete" onclick="deleteRule('${rule.rule_key}')">üóëÔ∏è Delete</button>
              </td>
            </tr>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error loading expiration rules:', error);
        document.getElementById('rulesBody').innerHTML = 
          '<tr><td colspan="6" class="empty-state">Error loading expiration rules. Please try again.</td></tr>';
      }
    }
    
    function editRule(ruleKey) {
      window.location.href = `admin_expiration_edit.html?rule_key=${encodeURIComponent(ruleKey)}&tenant_id=${tenantId}`;
    }
    
    async function deleteRule(ruleKey) {
      if (!confirm(`Are you sure you want to delete expiration rule "${ruleKey}"?`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/v1/expiration-rules/${encodeURIComponent(ruleKey)}?tenant_id=${tenantId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('Expiration rule deleted successfully');
          loadRules();
        } else {
          const error = await response.json();
          alert('Failed to delete: ' + (error.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error deleting rule:', error);
        alert('Error deleting rule');
      }
    }
    
    // Load rules on page load
    loadRules();
    
    // Update currency labels when LP_STATE is ready
    function updateCurrencyLabels() {
      const label = window.LP_STATE?.labels?.currency_label || 'Point';
      document.getElementById('currencyLabel').textContent = label;
      document.querySelectorAll('.currency-label-lower').forEach(el => {
        el.textContent = label.toLowerCase() + 's';
      });
      document.title = `${label} Expiration Rules - Admin`;
    }
    
    // Wait for lp-nav.js to load labels
    setTimeout(updateCurrencyLabels, 150);
  </script>
</body>
</html>
