<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Molecule - Admin</title>
  <link rel="stylesheet" href="theme.css">
  <link rel="stylesheet" href="buttons.css">
  <style>
    /* Fix page scrolling - force viewport height */
    html, body {
      height: 100%;
      overflow: hidden;
    }

    .app-layout {
      height: 100vh !important;
      min-height: auto !important;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .page-header {
      padding: 6px 0;
      margin-bottom: 8px;
      flex-shrink: 0;
    }

    .scrollable-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .fixed-actions {
      flex-shrink: 0;
      padding: 8px 0;
      border-top: 1px solid #e5e7eb;
      background: white;
      margin-top: 8px;
    }

    .page-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }

    .form-section {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #e5e7eb;
      color: #1f2937;
    }

    .form-row {
      display: grid;
      gap: 8px;
      margin-bottom: 6px;
    }

    .form-row.two-col { grid-template-columns: 1fr 1fr; }
    .form-row.three-col { grid-template-columns: 1fr 1fr 1fr; }
    .form-row.four-col { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .form-row.five-col { grid-template-columns: 1fr 1fr 1fr 1fr 80px; }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 12px;
      color: #374151;
    }

    label .required { color: #dc2626; }

    input, select, textarea {
      padding: 6px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 13px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 40px;
      font-family: inherit;
    }

    .radio-group {
      display: flex;
      gap: 12px;
      margin-top: 2px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: normal;
      font-size: 12px;
      cursor: pointer;
    }

    .radio-label input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }

    .hidden { display: none !important; }

    .help-text {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    /* Value table styling */
    .values-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }

    .values-table th {
      text-align: left;
      padding: 6px 8px;
      background: #f9fafb;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      border-bottom: 1px solid #e5e7eb;
    }

    .values-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }

    .values-table tr:hover {
      background: #f9fafb;
    }

    .col-type-select {
      width: 100%;
      padding: 4px 6px;
      font-size: 12px;
    }

    .values-table td input[type="text"] {
      width: 100%;
      padding: 4px 6px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      background: #f9fafb;
      border-radius: 4px;
      margin: 8px 0;
    }

    .empty-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 16px;
      width: 90%;
      max-width: 500px;
    }

    .modal-header {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">Loyalty Platform</div>
      <nav class="nav" id="nav-container"></nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h1 class="page-title" id="pageTitle">Add Molecule</h1>
        <button onclick="MoleculeTestModal.open(document.getElementById('moleculeKey').value)" class="btn btn-test" title="Test Molecule Functions">üß™ Test</button>
      </div>

      <div class="scrollable-content">
        <div class="page-content">
        <!-- Tenant Indicator -->
        <div id="tenantIndicator"></div>

        <!-- Molecule Definition (Top Section) -->
        <div class="form-section">
          <h2 class="section-title">Molecule Definition</h2>

          <div class="form-row five-col">
            <div class="form-group">
              <label>Key <span class="required">*</span></label>
              <input type="text" id="moleculeKey" placeholder="e.g., carrier" required>
            </div>

            <div class="form-group">
              <label>Label <span class="required">*</span></label>
              <input type="text" id="moleculeLabel" placeholder="e.g., Carrier Code" required>
            </div>

            <div class="form-group">
              <label>Context <span class="required">*</span></label>
              <select id="moleculeContext" required>
                <option value="">-- Select --</option>
                <option value="system">System</option>
                <option value="tenant">Tenant</option>
                <option value="program">Program</option>
                <option value="activity">Activity</option>
                <option value="member">Member</option>
              </select>
            </div>

            <div class="form-group">
              <label>Type <span class="required">*</span></label>
              <select id="moleculeType" required>
                <option value="">-- Select --</option>
                <option value="static">Static</option>
                <option value="dynamic">Dynamic</option>
                <option value="reference">Reference</option>
              </select>
            </div>

            <div class="form-group">
              <label>Width</label>
              <input type="number" id="displayWidth" placeholder="bytes" min="1" max="100">
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="moleculeDescription" placeholder="Optional description"></textarea>
          </div>
        </div>

        <!-- STORAGE Configuration (for activity/member dynamic molecules) -->
        <div id="storageConfig" class="form-section hidden">
          <h2 class="section-title">Storage Configuration</h2>
          
          <div class="form-row three-col">
            <div class="form-group">
              <label>Size (bytes)</label>
              <select id="storageSize">
                <option value="">-- Select --</option>
                <option value="1">1 - CHAR(1)</option>
                <option value="2">2 - SMALLINT</option>
                <option value="3">3 - CHAR(3)</option>
                <option value="4">4 - INTEGER</option>
                <option value="5">5 - CHAR(5)</option>
              </select>
            </div>

            <div class="form-group">
              <label>Value Type</label>
              <select id="valueType">
                <option value="">-- Select --</option>
                <option value="link">link - Primary Key</option>
                <option value="key">key - Foreign Key</option>
                <option value="numeric">numeric - Signed Number</option>
                <option value="code">code - Positive Number</option>
                <option value="date">date - Calendar Date</option>
                <option value="bigdate">bigdate - Extended Date</option>
              </select>
            </div>

            <div class="form-group">
              <label>Storage Table</label>
              <input type="text" id="storageTable" readonly style="background: #f9fafb;">
            </div>
          </div>
        </div>

        <!-- STATIC Configuration -->
        <div id="staticConfig" class="form-section hidden">
          <h2 class="section-title">Static Configuration</h2>

          <div class="form-group">
            <label>Subtype <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="staticSubtype" value="single_value">
                Single Value
              </label>
              <label class="radio-label">
                <input type="radio" name="staticSubtype" value="embedded_list">
                Embedded List
              </label>
            </div>
          </div>

          <!-- Single Value -->
          <div id="staticSingleValue" class="hidden">
            <div class="form-row two-col">
              <div class="form-group">
                <label>Data Type <span class="required">*</span></label>
                <select id="staticDataType">
                  <option value="">-- Select --</option>
                  <option value="text">Text</option>
                  <option value="numeric">Numeric</option>
                  <option value="date">Date</option>
                  <option value="boolean">Boolean</option>
                </select>
              </div>

              <div class="form-group">
                <label>Value <span class="required">*</span></label>
                <input type="text" id="staticValue" placeholder="e.g., Miles, 365">
              </div>
            </div>
          </div>

          <!-- Embedded List -->
          <div id="staticEmbeddedList" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <label style="margin: 0;">Category</label>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-delete" onclick="deleteCategory()" id="deleteCategoryBtn" style="display: none;">üóëÔ∏è Delete Category</button>
                <button class="btn btn-sm btn-add" onclick="addCategory()">‚ûï Add Category</button>
              </div>
            </div>

            <select id="categorySelector" style="width: 100%; margin-bottom: 8px;">
              <option value="">-- Select category --</option>
            </select>

            <div id="embeddedListEmptyState" class="empty-state">
              <div class="empty-icon">üìÇ</div>
              <p>No category selected</p>
            </div>

            <div id="categoryValuesSection" class="hidden">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 12px;">Values in <span id="selectedCategoryName"></span></span>
                <button class="btn btn-sm btn-primary" onclick="addCategoryValue()">‚ûï Add Value</button>
              </div>

              <table class="values-table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Code</th>
                    <th style="width: 50%;">Description</th>
                    <th style="width: 15%;">Sort</th>
                    <th style="width: 15%; text-align: right;">Actions</th>
                  </tr>
                </thead>
                <tbody id="categoryValuesTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- DYNAMIC Configuration -->
        <div id="dynamicConfig" class="form-section hidden">
          <h2 class="section-title">Dynamic Configuration</h2>

          <div class="form-group">
            <label>Value Structure <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="dynamicStructure" value="single">
                Single Value
              </label>
              <label class="radio-label">
                <input type="radio" name="dynamicStructure" value="embedded">
                Embedded List
              </label>
            </div>
          </div>

          <!-- Single Value Options -->
          <div id="dynamicSingleValue" class="hidden">
            <div class="form-group">
              <label>Subtype <span class="required">*</span></label>
              <div class="radio-group">
                <label class="radio-label">
                  <input type="radio" name="dynamicSubtype" value="lookup">
                  Lookup
                </label>
                <label class="radio-label">
                  <input type="radio" name="dynamicSubtype" value="freeform">
                  Value
                  
                </label>
              </div>
            </div>

            <!-- Lookup -->
            <div id="dynamicLookup" class="hidden">
              <div class="form-group">
                <label>Source <span class="required">*</span></label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="lookupSource" value="internal">
                    Internal
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="lookupSource" value="external">
                    External
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label>Input Type</label>
                <select id="inputType" style="max-width: 200px;">
                  <option value="P">Pulldown</option>
                  <option value="T">Typeahead</option>
                  <option value="R">Radio buttons</option>
                  <option value="C">Checkboxes</option>
                </select>
              <div class="help-text">How this field should be rendered in forms. Use Typeahead for large lists (100+ items).</div>
            </div>

            <!-- Internal Lookup -->
            <div id="lookupInternal" class="hidden">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label style="margin: 0;">List Values</label>
                <button class="btn btn-sm btn-primary" onclick="addListValue()">‚ûï Add Value</button>
              </div>

              <div id="listEmptyState" class="empty-state">
                <div class="empty-icon">üìù</div>
                <p>No values defined yet</p>
              </div>

              <table id="valuesTable" class="values-table hidden">
                <thead>
                  <tr>
                    <th style="width: 20%;">Code</th>
                    <th style="width: 50%;">Description</th>
                    <th style="width: 15%;">Sort</th>
                    <th style="width: 15%; text-align: right;">Actions</th>
                  </tr>
                </thead>
                <tbody id="valuesTableBody">
                </tbody>
              </table>
            </div>

            <!-- External Lookup -->
            <div id="lookupExternal" class="hidden">
              <div class="form-row two-col">
                <div class="form-group">
                  <label>Table Name <span class="required">*</span></label>
                  <input type="text" id="externalTable" placeholder="e.g., carriers">
                </div>

                <div class="form-group">
                  <label>ID Column <span class="required">*</span></label>
                  <input type="text" id="externalIdColumn" placeholder="e.g., carrier_id">
                </div>
              </div>
              <div class="form-row two-col">
                <div class="form-group">
                  <label>Code Column <span class="required">*</span></label>
                  <input type="text" id="externalCodeColumn" placeholder="e.g., code">
                </div>

                <div class="form-group">
                  <label>Description Column <span class="required">*</span></label>
                  <input type="text" id="externalDescColumn" placeholder="e.g., name">
                </div>
              </div>
            </div>
          </div>

          <!-- Value (scalar) -->
          <div id="dynamicFreeform" class="hidden">
            <div class="form-group">
              <label>Data Type <span class="required">*</span></label>
              <select id="freeformDataType" onchange="toggleDecimalPlaces()">
                <option value="">-- Select --</option>
                <option value="text">Text</option>
                <option value="numeric">Numeric</option>
              </select>
              <div class="help-text">User-entered values will be deduplicated and stored</div>
            </div>
            
            <div id="decimalPlacesField" class="form-group hidden">
              <label>Decimal Places <span class="required">*</span></label>
              <input type="number" id="decimalPlaces" min="0" max="4" value="0" placeholder="e.g., 0 for integers, 2 for currency">
              <div class="help-text">Number of decimal places (0 for integers, 2 for currency)</div>
            </div>
            
            <div id="promotionCounterField" class="form-group hidden">
              <label>
                <input type="checkbox" id="canBePromotionCounter" style="width: auto; margin-right: 6px;">
                Can be used as Promotion Counter
              </label>
              <div class="help-text">Check if this value should be available for summing in promotions (e.g., MQD=yes, flight_number=no)</div>
            </div>
          </div>
          </div> <!-- Close dynamicSingleValue -->

          <!-- Dynamic Embedded List info -->
          <div id="dynamicEmbedded" class="hidden">
            <div class="help-text" style="margin-bottom: 12px;">
              Embedded list molecules store multiple rows per activity or member (e.g., member_points, member_point_bucket).
              Define the columns below.
            </div>
          </div>

          <!-- Column Definitions - shown for ALL dynamic molecules -->
          <div id="columnDefinitionsSection" class="hidden">
            <div style="margin-top: 12px;">
              <label style="font-weight: 600; margin-bottom: 8px; display: block;">Column Definitions</label>
              <div class="help-text" style="margin-bottom: 8px;">Define what each column (A-F) stores for this molecule</div>
              
              <table class="values-table">
                <thead>
                  <tr>
                    <th style="width: 15%;">Column</th>
                    <th style="width: 25%;">Type</th>
                    <th style="width: 60%;">Description</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>A</strong></td>
                    <td>
                      <select id="colAType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colADesc" placeholder="e.g., rule_id, bucket_id"></td>
                  </tr>
                  <tr>
                    <td><strong>B</strong></td>
                    <td>
                      <select id="colBType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colBDesc" placeholder="e.g., amount"></td>
                  </tr>
                  <tr>
                    <td><strong>C</strong></td>
                    <td>
                      <select id="colCType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colCDesc" placeholder="e.g., accrued"></td>
                  </tr>
                  <tr>
                    <td><strong>D</strong></td>
                    <td>
                      <select id="colDType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colDDesc" placeholder="e.g., redeemed"></td>
                  </tr>
                  <tr>
                    <td><strong>E</strong></td>
                    <td>
                      <select id="colEType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colEDesc" placeholder="e.g., expire_date"></td>
                  </tr>
                  <tr>
                    <td><strong>F</strong></td>
                    <td>
                      <select id="colFType" class="col-type-select">
                        <option value="">(unused)</option>
                        <option value="ref">Reference (BIGINT)</option>
                        <option value="key">Key (Foreign Key)</option>
                        <option value="numeric">Numeric</option>
                        <option value="date">Date</option>
                      </select>
                    </td>
                    <td><input type="text" id="colFDesc" placeholder="e.g., qualify_date"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- REFERENCE Configuration -->
        <div id="referenceConfig" class="form-section hidden">
          <h2 class="section-title">Reference Configuration</h2>

          <div class="form-group">
            <label>Subtype <span class="required">*</span></label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="referenceSubtype" value="direct_field">
                Direct Field
              </label>
              <label class="radio-label">
                <input type="radio" name="referenceSubtype" value="function">
                Function
              </label>
            </div>
          </div>

          <!-- Direct Field -->
          <div id="referenceDirectField" class="hidden">
            <div class="form-row two-col">
              <div class="form-group">
                <label>Table Name <span class="required">*</span></label>
                <input type="text" id="refTableName" placeholder="e.g., member">
              </div>

              <div class="form-group">
                <label>Field Name <span class="required">*</span></label>
                <input type="text" id="refFieldName" placeholder="e.g., fname">
              </div>
            </div>
          </div>

          <!-- Function -->
          <div id="referenceFunction" class="hidden">
            <div class="form-group">
              <label>Function Name <span class="required">*</span></label>
              <input type="text" id="refFunctionName" placeholder="e.g., get_member_tier_on_date">
              <div class="help-text">Function must accept (id, date) parameters</div>
            </div>
          </div>
        </div>

        </div><!-- /page-content -->
      </div><!-- /scrollable-content -->

      <!-- Fixed Action Buttons -->
      <div class="fixed-actions">
        <div class="actions">
          <button type="button" class="btn btn-secondary btn-lg" onclick="history.back()">
            ‚Üê Back
          </button>
          <button type="button" class="btn btn-primary btn-lg" onclick="saveMolecule()">
            üíæ Save Molecule
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal for adding/editing values -->
  <div id="valueModal" class="modal-overlay">
    <div class="modal-content">
      <h2 class="modal-header" id="modalTitle">Add Value</h2>
      
      <div class="form-group">
        <label>Code <span class="required">*</span></label>
        <input type="text" id="modalCode" placeholder="e.g., A, DL, Y">
      </div>

      <div class="form-group">
        <label>Description <span class="required">*</span></label>
        <input type="text" id="modalDescription" placeholder="e.g., Base Activity">
      </div>

      <div class="form-group">
        <label>Sort Order</label>
        <input type="number" id="modalSort" value="10">
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveModalValue()">üíæ Save</button>
      </div>
    </div>
  </div>

  <!-- Modal for adding category -->
  <div id="categoryModal" class="modal-overlay">
    <div class="modal-content">
      <h2 class="modal-header">Add Category</h2>
      
      <div class="form-group">
        <label>Category Name <span class="required">*</span></label>
        <input type="text" id="modalCategoryName" placeholder="e.g., activity_type">
        <div class="help-text">Unique identifier for this category</div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveCategoryModal()">üíæ Save</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="lp-nav.js"></script>
  <script src="molecule-test-modal.js"></script>
  <script>
    // =====================================================
    // State
    // =====================================================
    
    const tenantId = sessionStorage.getItem('tenant_id');
    const tenantName = sessionStorage.getItem('tenant_name');
    const urlParams = new URLSearchParams(window.location.search);
    const moleculeId = urlParams.get('id');

    let currentValues = []; // For internal lookup values
    let currentCategory = null; // For embedded list
    let editingValueCode = null; // For edit mode in modal

    // =====================================================
    // Initialization
    // =====================================================
    
    if (tenantId && tenantName) {
      document.getElementById('tenantIndicator').innerHTML = `
        <div style="background: #dbeafe; padding: 6px 10px; border-radius: 6px; margin-bottom: 8px; font-size: 12px;">
          <span style="font-weight: 600;">Tenant:</span> ${tenantName}
        </div>
      `;
    }

    if (moleculeId) {
      document.getElementById('pageTitle').textContent = 'Edit Molecule';
      loadMolecule(moleculeId);
    }

    // =====================================================
    // Helper Functions
    // =====================================================
    
    function toggleDecimalPlaces() {
      const dataType = document.getElementById('freeformDataType').value;
      const decimalField = document.getElementById('decimalPlacesField');
      const promotionCounterField = document.getElementById('promotionCounterField');
      if (dataType === 'numeric') {
        decimalField.classList.remove('hidden');
        promotionCounterField.classList.remove('hidden');
      } else {
        decimalField.classList.add('hidden');
        promotionCounterField.classList.add('hidden');
      }
    }

    // =====================================================
    // Progressive Disclosure
    // =====================================================
    
    function updateStorageConfigVisibility() {
      const context = document.getElementById('moleculeContext').value;
      const type = document.getElementById('moleculeType').value;
      const storageConfig = document.getElementById('storageConfig');
      
      // Show storage config for activity/member dynamic molecules
      if ((context === 'activity' || context === 'member') && type === 'dynamic') {
        storageConfig.classList.remove('hidden');
      } else {
        storageConfig.classList.add('hidden');
      }
    }
    
    function updateStorageTable() {
      const context = document.getElementById('moleculeContext').value;
      const size = document.getElementById('storageSize').value;
      const storageTableInput = document.getElementById('storageTable');
      
      if (context && size) {
        const prefix = context === 'activity' ? 'activity_detail_' : 'member_detail_';
        storageTableInput.value = prefix + size;
      } else {
        storageTableInput.value = '';
      }
    }
    
    document.getElementById('moleculeContext').addEventListener('change', function() {
      updateStorageConfigVisibility();
      updateStorageTable();
    });
    
    document.getElementById('storageSize').addEventListener('change', updateStorageTable);
    
    document.getElementById('moleculeType').addEventListener('change', function() {
      document.getElementById('staticConfig').classList.add('hidden');
      document.getElementById('dynamicConfig').classList.add('hidden');
      document.getElementById('referenceConfig').classList.add('hidden');
      document.getElementById('columnDefinitionsSection').classList.add('hidden');

      if (this.value === 'static') document.getElementById('staticConfig').classList.remove('hidden');
      if (this.value === 'dynamic') document.getElementById('dynamicConfig').classList.remove('hidden');
      if (this.value === 'reference') document.getElementById('referenceConfig').classList.remove('hidden');
      
      updateStorageConfigVisibility();
    });

    document.querySelectorAll('input[name="staticSubtype"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('staticSingleValue').classList.add('hidden');
        document.getElementById('staticEmbeddedList').classList.add('hidden');
        if (this.value === 'single_value') document.getElementById('staticSingleValue').classList.remove('hidden');
        if (this.value === 'embedded_list') document.getElementById('staticEmbeddedList').classList.remove('hidden');
      });
    });

    // Dynamic structure toggle (Single Value vs Embedded List)
    document.querySelectorAll('input[name="dynamicStructure"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('dynamicSingleValue').classList.add('hidden');
        document.getElementById('dynamicEmbedded').classList.add('hidden');
        document.getElementById('columnDefinitionsSection').classList.add('hidden');
        
        if (this.value === 'single') {
          document.getElementById('dynamicSingleValue').classList.remove('hidden');
          // Column definitions NOT shown for single value
        } else if (this.value === 'embedded') {
          document.getElementById('dynamicEmbedded').classList.remove('hidden');
          document.getElementById('columnDefinitionsSection').classList.remove('hidden');
        }
      });
    });

    document.querySelectorAll('input[name="dynamicSubtype"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('dynamicLookup').classList.add('hidden');
        document.getElementById('dynamicFreeform').classList.add('hidden');
        // NO column definitions for single value molecules
        if (this.value === 'lookup') document.getElementById('dynamicLookup').classList.remove('hidden');
        if (this.value === 'freeform') document.getElementById('dynamicFreeform').classList.remove('hidden');
      });
    });

    document.querySelectorAll('input[name="lookupSource"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('lookupInternal').classList.add('hidden');
        document.getElementById('lookupExternal').classList.add('hidden');
        if (this.value === 'internal') document.getElementById('lookupInternal').classList.remove('hidden');
        if (this.value === 'external') document.getElementById('lookupExternal').classList.remove('hidden');
      });
    });

    document.querySelectorAll('input[name="referenceSubtype"]').forEach(radio => {
      radio.addEventListener('change', function() {
        document.getElementById('referenceDirectField').classList.add('hidden');
        document.getElementById('referenceFunction').classList.add('hidden');
        if (this.value === 'direct_field') document.getElementById('referenceDirectField').classList.remove('hidden');
        if (this.value === 'function') document.getElementById('referenceFunction').classList.remove('hidden');
      });
    });

    // Category selector change
    document.getElementById('categorySelector').addEventListener('change', function() {
      currentCategory = this.value;
      const deleteBtn = document.getElementById('deleteCategoryBtn');
      
      if (currentCategory) {
        loadCategoryValues(currentCategory);
        document.getElementById('embeddedListEmptyState').classList.add('hidden');
        document.getElementById('categoryValuesSection').classList.remove('hidden');
        document.getElementById('selectedCategoryName').textContent = currentCategory;
        deleteBtn.style.display = 'block'; // Show delete button
      } else {
        document.getElementById('embeddedListEmptyState').classList.remove('hidden');
        document.getElementById('categoryValuesSection').classList.add('hidden');
        deleteBtn.style.display = 'none'; // Hide delete button
      }
    });

    async function loadCategoryValues(category) {
      const tbody = document.getElementById('categoryValuesTableBody');
      
      if (!moleculeId) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 20px; color: #dc2626;">
              Error: Molecule ID not set. Please save the molecule first.
            </td>
          </tr>
        `;
        return;
      }
      
      try {
        const url = `/v1/molecules/${moleculeId}/embedded-values?tenant_id=${tenantId}&category=${encodeURIComponent(category)}`;
        console.log('Loading category values from:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('API error:', response.status, errorData);
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 20px; color: #dc2626;">
                Error loading values: ${errorData.error || `HTTP ${response.status}`}
              </td>
            </tr>
          `;
          return;
        }
        
        const values = await response.json();
        console.log(`Loaded ${values.length} values for category "${category}"`);
        
        if (values.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">
                No values in this category yet. Click "‚ûï Add Value" to create one.
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = values.map(v => `
            <tr>
              <td>${v.code}</td>
              <td>${v.description}</td>
              <td>${v.sort_order || 0}</td>
              <td style="text-align: right;">
                <button class="btn btn-sm btn-edit" onclick="editCategoryValue(${v.embedded_value_id}, '${v.code}', '${v.description}', ${v.sort_order || 0})" title="Edit">‚úèÔ∏è Edit</button>
                <button class="btn btn-sm btn-delete" onclick="deleteCategoryValue('${v.code}')" title="Delete">üóëÔ∏è Delete</button>
              </td>
            </tr>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading category values:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 20px; color: #dc2626;">
              Error: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // =====================================================
    // Load Molecule
    // =====================================================
    
    async function loadMolecule(id) {
      try {
        const response = await fetch(`/v1/molecules/${id}`);
        if (!response.ok) throw new Error('Failed to load molecule');
        const molecule = await response.json();

        // Populate top section
        document.getElementById('moleculeKey').value = molecule.molecule_key;
        document.getElementById('moleculeLabel').value = molecule.label;
        document.getElementById('moleculeContext').value = molecule.context;
        document.getElementById('moleculeDescription').value = molecule.description || '';
        document.getElementById('displayWidth').value = molecule.display_width || '';

        // Use new molecule_type and value_structure fields
        const moleculeType = molecule.molecule_type || (molecule.is_static ? 'S' : 'D');
        const valueStructure = molecule.value_structure || 'single';
        const valueKind = molecule.value_kind;
        let type, subtype;
        
        if (moleculeType === 'S' && valueStructure === 'single') {
          // Static single value
          type = 'static';
          subtype = 'single_value';
          document.getElementById('staticDataType').value = molecule.scalar_type || 'text';
          // Load the actual scalar value
          loadScalarValue(id);
        } else if (moleculeType === 'S' && valueStructure === 'embedded') {
          // Static embedded list
          type = 'static';
          subtype = 'embedded_list';
          // Load categories
          loadEmbeddedCategories(id);
        } else if (moleculeType === 'D' && valueStructure === 'single' && valueKind === 'value') {
          // Dynamic value (user-entered)
          type = 'dynamic';
          subtype = 'freeform';
          // Set structure radio
          document.querySelector('input[name="dynamicStructure"][value="single"]').checked = true;
          document.querySelector('input[name="dynamicStructure"][value="single"]').dispatchEvent(new Event('change'));
          document.getElementById('freeformDataType').value = molecule.scalar_type || 'text';
          // Load decimal places and promotion counter if numeric
          if (molecule.scalar_type === 'numeric') {
            document.getElementById('decimalPlaces').value = molecule.decimal_places || 0;
            document.getElementById('canBePromotionCounter').checked = molecule.can_be_promotion_counter || false;
            toggleDecimalPlaces(); // Show the fields
          }
        } else if (moleculeType === 'D' && valueStructure === 'single' && valueKind === 'internal_list') {
          // Dynamic internal list
          type = 'dynamic';
          subtype = 'lookup';
          // Set structure radio
          document.querySelector('input[name="dynamicStructure"][value="single"]').checked = true;
          document.querySelector('input[name="dynamicStructure"][value="single"]').dispatchEvent(new Event('change'));
          // Set subtype radio AND dispatch change to show lookup section
          document.querySelector('input[name="dynamicSubtype"][value="lookup"]').checked = true;
          document.querySelector('input[name="dynamicSubtype"][value="lookup"]').dispatchEvent(new Event('change'));
          document.querySelector('input[name="lookupSource"][value="internal"]').checked = true;
          document.querySelector('input[name="lookupSource"][value="internal"]').dispatchEvent(new Event('change'));
          // Load input type
          document.getElementById('inputType').value = molecule.input_type || 'P';
          // Load list values
          loadListValues(id);
        } else if (moleculeType === 'D' && valueStructure === 'single' && valueKind === 'external_list') {
          // Dynamic external lookup
          type = 'dynamic';
          subtype = 'lookup';
          // Set structure radio
          document.querySelector('input[name="dynamicStructure"][value="single"]').checked = true;
          document.querySelector('input[name="dynamicStructure"][value="single"]').dispatchEvent(new Event('change'));
          // Set subtype radio AND dispatch change to show lookup section
          document.querySelector('input[name="dynamicSubtype"][value="lookup"]').checked = true;
          document.querySelector('input[name="dynamicSubtype"][value="lookup"]').dispatchEvent(new Event('change'));
          document.querySelector('input[name="lookupSource"][value="external"]').checked = true;
          document.querySelector('input[name="lookupSource"][value="external"]').dispatchEvent(new Event('change'));
          // Load input type
          document.getElementById('inputType').value = molecule.input_type || 'P';
          // Load external lookup configuration
          loadLookupConfig(id);
        } else if (moleculeType === 'D' && valueStructure === 'embedded') {
          // Dynamic embedded list (member_points, member_point_bucket)
          type = 'dynamic';
          // Set structure radio
          document.querySelector('input[name="dynamicStructure"][value="embedded"]').checked = true;
          document.querySelector('input[name="dynamicStructure"][value="embedded"]').dispatchEvent(new Event('change'));
          // Load column definitions
          loadColumnDefinitions(id);
        } else if (moleculeType === 'R') {
          // Reference molecule
          type = 'reference';
          // Determine subtype based on which fields are populated
          if (molecule.ref_function_name) {
            subtype = 'function';
            document.getElementById('refFunctionName').value = molecule.ref_function_name;
          } else if (molecule.ref_table_name && molecule.ref_field_name) {
            subtype = 'direct_field';
            document.getElementById('refTableName').value = molecule.ref_table_name;
            document.getElementById('refFieldName').value = molecule.ref_field_name;
          }
        } else {
          // Fallback: use old logic for backward compatibility
          const isStatic = molecule.is_static;
          if (valueKind === 'scalar' && isStatic) {
            type = 'static';
            subtype = 'single_value';
            document.getElementById('staticDataType').value = molecule.scalar_type || 'text';
            loadScalarValue(id);
          } else if (valueKind === 'scalar' && !isStatic) {
            type = 'dynamic';
            subtype = 'freeform';
            document.getElementById('freeformDataType').value = molecule.scalar_type || 'text';
            if (molecule.scalar_type === 'numeric') {
              document.getElementById('decimalPlaces').value = molecule.decimal_places || 0;
              document.getElementById('canBePromotionCounter').checked = molecule.can_be_promotion_counter || false;
              toggleDecimalPlaces();
            }
          } else if (valueKind === 'embedded_list') {
            type = 'static';
            subtype = 'embedded_list';
            loadEmbeddedCategories(id);
          } else if (valueKind === 'list') {
            type = 'dynamic';
            subtype = 'lookup';
            document.querySelector('input[name="dynamicSubtype"][value="lookup"]').checked = true;
            document.querySelector('input[name="dynamicSubtype"][value="lookup"]').dispatchEvent(new Event('change'));
            document.querySelector('input[name="lookupSource"][value="internal"]').checked = true;
            document.querySelector('input[name="lookupSource"][value="internal"]').dispatchEvent(new Event('change'));
            document.getElementById('inputType').value = molecule.input_type || 'P';
            loadListValues(id);
          } else if (valueKind === 'lookup') {
            type = 'dynamic';
            subtype = 'lookup';
            document.querySelector('input[name="dynamicSubtype"][value="lookup"]').checked = true;
            document.querySelector('input[name="dynamicSubtype"][value="lookup"]').dispatchEvent(new Event('change'));
            document.querySelector('input[name="lookupSource"][value="external"]').checked = true;
            document.querySelector('input[name="lookupSource"][value="external"]').dispatchEvent(new Event('change'));
            document.getElementById('inputType').value = molecule.input_type || 'P';
            loadLookupConfig(id);
          } else if (valueKind === 'reference') {
            type = 'reference';
            if (molecule.ref_function_name) {
              subtype = 'function';
              document.getElementById('refFunctionName').value = molecule.ref_function_name;
            } else if (molecule.ref_table_name && molecule.ref_field_name) {
              subtype = 'direct_field';
              document.getElementById('refTableName').value = molecule.ref_table_name;
              document.getElementById('refFieldName').value = molecule.ref_field_name;
            }
          } else if (valueKind === 'dynamic_list') {
            type = 'dynamic';
            subtype = 'lookup';
            loadColumnDefinitions(id);
          }
        }
        
        document.getElementById('moleculeType').value = type;
        document.getElementById('moleculeType').dispatchEvent(new Event('change'));
        
        if (subtype) {
          const radio = document.querySelector(`input[name="${type}Subtype"][value="${subtype}"]`);
          if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
          }
        }
        
        // Load storage configuration fields
        if (molecule.storage_size) {
          document.getElementById('storageSize').value = molecule.storage_size;
        }
        if (molecule.value_type) {
          document.getElementById('valueType').value = molecule.value_type;
        }
        if (molecule.storage_table) {
          document.getElementById('storageTable').value = molecule.storage_table;
        }
        // Trigger visibility update
        updateStorageConfigVisibility();
        
      } catch (error) {
        console.error('Error loading molecule:', error);
        alert('Failed to load molecule');
      }
    }

    async function loadEmbeddedCategories(moleculeId) {
      try {
        const response = await fetch(`/v1/molecules/${moleculeId}/embedded-categories?tenant_id=${tenantId}`);
        if (!response.ok) return;
        const categories = await response.json();
        
        const selector = document.getElementById('categorySelector');
        selector.innerHTML = '<option value="">-- Select category --</option>';
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          selector.appendChild(option);
        });
        
        // Auto-select first category and load its values
        if (categories.length > 0) {
          selector.value = categories[0];
          selector.dispatchEvent(new Event('change'));
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    async function loadScalarValue(moleculeId) {
      try {
        const response = await fetch(`/v1/molecules/${moleculeId}/value?tenant_id=${tenantId}`);
        if (!response.ok) return;
        const data = await response.json();
        
        if (data.value !== null && data.value !== undefined) {
          document.getElementById('staticValue').value = data.value;
        }
      } catch (error) {
        console.error('Error loading scalar value:', error);
      }
    }

    async function loadLookupConfig(moleculeId) {
      try {
        const response = await fetch(`/v1/molecules/${moleculeId}/lookup-config?tenant_id=${tenantId}`);
        if (!response.ok) return;
        const config = await response.json();
        
        document.getElementById('externalTable').value = config.table_name || '';
        document.getElementById('externalIdColumn').value = config.id_column || '';
        document.getElementById('externalCodeColumn').value = config.code_column || '';
        document.getElementById('externalDescColumn').value = config.label_column || '';
      } catch (error) {
        console.error('Error loading lookup config:', error);
      }
    }

    async function loadListValues(moleculeId) {
      try {
        const response = await fetch(`/v1/molecules/${moleculeId}/values?tenant_id=${tenantId}`);
        if (!response.ok) return;
        const values = await response.json();
        
        currentValues = values.map(v => ({
          value_id: v.value_id,
          code: v.value,
          description: v.label,
          sort_order: v.sort_order
        }));
        
        renderListValues();
      } catch (error) {
        console.error('Error loading list values:', error);
      }
    }

    async function loadColumnDefinitions(moleculeId) {
      try {
        const response = await fetch(`/v1/molecules/${moleculeId}/column-definitions?tenant_id=${tenantId}`);
        if (!response.ok) return;
        const columns = await response.json();
        
        // Clear all column fields first
        const colLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
        colLetters.forEach(letter => {
          document.getElementById(`col${letter}Type`).value = '';
          document.getElementById(`col${letter}Desc`).value = '';
        });
        
        // Populate from saved definitions
        columns.forEach(col => {
          const letter = col.column_name;
          if (colLetters.includes(letter)) {
            document.getElementById(`col${letter}Type`).value = col.column_type || '';
            document.getElementById(`col${letter}Desc`).value = col.description || '';
          }
        });
      } catch (error) {
        console.error('Error loading column definitions:', error);
      }
    }

    // =====================================================
    // Internal Lookup Values
    // =====================================================
    
    function addListValue() {
      editingValueCode = null;
      document.getElementById('modalTitle').textContent = 'Add Value';
      document.getElementById('modalCode').value = '';
      document.getElementById('modalDescription').value = '';
      document.getElementById('modalSort').value = '10';
      document.getElementById('valueModal').classList.add('active');
      
      // Set flag so saveModalValue knows this is for internal lookup
      document.getElementById('valueModal').dataset.context = 'internal';
    }

    function editListValue(code) {
      const value = currentValues.find(v => v.code === code);
      if (!value) return;

      editingValueCode = code;
      document.getElementById('modalTitle').textContent = 'Edit Value';
      document.getElementById('modalCode').value = value.code;
      document.getElementById('modalDescription').value = value.description;
      document.getElementById('modalSort').value = value.sort_order || 10;
      document.getElementById('valueModal').classList.add('active');
      
      // Set flag so saveModalValue knows this is for internal lookup
      document.getElementById('valueModal').dataset.context = 'internal';
    }

    async function deleteListValue(code) {
      if (!confirm('Delete this value?')) return;
      
      const value = currentValues.find(v => v.code === code);
      if (!value || !value.value_id) {
        // Value not yet saved to API, just remove from local array
        currentValues = currentValues.filter(v => v.code !== code);
        renderListValues();
        return;
      }
      
      if (!moleculeId) {
        // No molecule ID yet, just remove from local array
        currentValues = currentValues.filter(v => v.code !== code);
        renderListValues();
        return;
      }
      
      try {
        const response = await fetch(
          `/v1/molecules/${moleculeId}/values/${value.value_id}?tenant_id=${tenantId}`,
          { method: 'DELETE' }
        );
        
        if (!response.ok) {
          throw new Error('Failed to delete value');
        }
        
        // Remove from local array and re-render
        currentValues = currentValues.filter(v => v.code !== code);
        renderListValues();
      } catch (error) {
        console.error('Error deleting list value:', error);
        alert('Failed to delete value');
      }
    }

    async function saveListValue() {
      const code = document.getElementById('modalCode').value.trim();
      const description = document.getElementById('modalDescription').value.trim();
      const sort_order = parseInt(document.getElementById('modalSort').value) || 10;

      if (!code || !description) {
        alert('Code and Description are required');
        return;
      }

      if (!moleculeId) {
        // No molecule saved yet - just update local array (will save when molecule is created)
        if (editingValueCode && editingValueCode !== code) {
          currentValues = currentValues.filter(v => v.code !== editingValueCode);
        }

        const existing = currentValues.findIndex(v => v.code === code);
        if (existing >= 0) {
          currentValues[existing] = { code, description, sort_order };
        } else {
          currentValues.push({ code, description, sort_order });
        }

        renderListValues();
        closeModal();
        return;
      }

      try {
        // Find the existing value to get its value_id
        const existingValue = currentValues.find(v => v.code === (editingValueCode || code));
        
        const data = {
          tenant_id: tenantId,
          value: code,
          label: description,
          sort_order: sort_order
        };

        let response;
        if (existingValue && existingValue.value_id) {
          // Update existing value via API
          response = await fetch(
            `/v1/molecules/${moleculeId}/values/${existingValue.value_id}`,
            {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            }
          );
        } else {
          // Create new value via API
          response = await fetch(
            `/v1/molecules/${moleculeId}/values`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            }
          );
        }

        if (!response.ok) {
          throw new Error('Failed to save value');
        }

        // Reload values from API to get fresh data with IDs
        await loadListValues(moleculeId);
        closeModal();
      } catch (error) {
        console.error('Error saving list value:', error);
        alert('Failed to save value');
      }
    }

    function saveModalValue() {
      const modal = document.getElementById('valueModal');
      const context = modal.dataset.context;
      
      // Route to appropriate handler
      if (context === 'embedded') {
        saveCategoryValue();
      } else if (context === 'internal') {
        saveListValue();
      } else {
        // Fallback to old local-only behavior for backward compatibility
        const code = document.getElementById('modalCode').value.trim();
        const description = document.getElementById('modalDescription').value.trim();
        const sort = parseInt(document.getElementById('modalSort').value) || 10;

        if (!code || !description) {
          alert('Code and Description are required');
          return;
        }

        if (editingValueCode && editingValueCode !== code) {
          currentValues = currentValues.filter(v => v.code !== editingValueCode);
        }

        const existing = currentValues.findIndex(v => v.code === code);
        if (existing >= 0) {
          currentValues[existing] = { code, description, sort_order: sort };
        } else {
          currentValues.push({ code, description, sort_order: sort });
        }

        renderListValues();
        closeModal();
      }
    }

    function renderListValues() {
      const tbody = document.getElementById('valuesTableBody');
      const table = document.getElementById('valuesTable');
      const emptyState = document.getElementById('listEmptyState');

      if (currentValues.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      table.classList.remove('hidden');
      emptyState.classList.add('hidden');

      currentValues.sort((a, b) => (a.sort_order || 10) - (b.sort_order || 10));

      tbody.innerHTML = currentValues.map(v => `
        <tr>
          <td>${v.code}</td>
          <td>${v.description}</td>
          <td>${v.sort_order || 10}</td>
          <td style="text-align: right;">
            <button class="btn btn-sm btn-edit" onclick="editListValue('${v.code}')" title="Edit">‚úèÔ∏è Edit</button>
            <button class="btn btn-sm btn-delete" onclick="deleteListValue('${v.code}')" title="Delete">üóëÔ∏è Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function closeModal() {
      document.getElementById('valueModal').classList.remove('active');
    }

    // =====================================================
    // Embedded List - Categories
    // =====================================================
    
    function addCategory() {
      document.getElementById('modalCategoryName').value = '';
      document.getElementById('categoryModal').classList.add('active');
    }

    function saveCategoryModal() {
      const categoryName = document.getElementById('modalCategoryName').value.trim();
      if (!categoryName) {
        alert('Category name is required');
        return;
      }

      // Add to selector
      const selector = document.getElementById('categorySelector');
      const option = document.createElement('option');
      option.value = categoryName;
      option.textContent = categoryName;
      selector.appendChild(option);
      selector.value = categoryName;
      selector.dispatchEvent(new Event('change'));

      closeCategoryModal();
    }

    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
    }


    // =====================================================
    // Embedded List - Category Values
    // =====================================================
    
    let editingCategoryValue = null; // Store embedded_value_id when editing

    function addCategoryValue() {
      if (!currentCategory) {
        alert('Please select a category first');
        return;
      }
      editingCategoryValue = null;
      document.getElementById('modalTitle').textContent = `Add Value to ${currentCategory}`;
      document.getElementById('modalCode').value = '';
      document.getElementById('modalDescription').value = '';
      document.getElementById('modalSort').value = '10';
      document.getElementById('valueModal').classList.add('active');
      
      // Set flag so saveModalValue knows this is for embedded values
      document.getElementById('valueModal').dataset.context = 'embedded';
    }

    function editCategoryValue(valueId, code, description, sortOrder) {
      if (!currentCategory) return;
      
      editingCategoryValue = valueId;
      document.getElementById('modalTitle').textContent = `Edit Value in ${currentCategory}`;
      document.getElementById('modalCode').value = code;
      document.getElementById('modalDescription').value = description;
      document.getElementById('modalSort').value = sortOrder;
      document.getElementById('valueModal').classList.add('active');
      
      // Set flag so saveModalValue knows this is for embedded values
      document.getElementById('valueModal').dataset.context = 'embedded';
    }

    async function deleteCategoryValue(code) {
      if (!confirm('Delete this value?')) return;
      if (!moleculeId || !currentCategory) return;
      
      try {
        const response = await fetch(
          `/v1/molecules/${moleculeId}/embedded-values/${encodeURIComponent(code)}?tenant_id=${tenantId}&category=${encodeURIComponent(currentCategory)}`,
          { method: 'DELETE' }
        );
        
        if (!response.ok) {
          throw new Error('Failed to delete value');
        }
        
        // Reload values
        await loadCategoryValues(currentCategory);
      } catch (error) {
        console.error('Error deleting category value:', error);
        alert('Failed to delete value');
      }
    }

    async function deleteCategory() {
      if (!currentCategory) return;
      
      if (!confirm(`Delete entire category "${currentCategory}" and all its values?`)) return;
      if (!moleculeId) return;
      
      try {
        const response = await fetch(
          `/v1/molecules/${moleculeId}/categories/${encodeURIComponent(currentCategory)}?tenant_id=${tenantId}`,
          { method: 'DELETE' }
        );
        
        if (!response.ok) {
          throw new Error('Failed to delete category');
        }
        
        const result = await response.json();
        alert(`Category deleted. Removed ${result.deleted_count} value(s).`);
        
        // Reload categories
        await loadCategories();
        
        // Reset selection
        document.getElementById('categorySelector').value = '';
        currentCategory = null;
        document.getElementById('deleteCategoryBtn').style.display = 'none';
        document.getElementById('embeddedListEmptyState').classList.remove('hidden');
        document.getElementById('categoryValuesSection').classList.add('hidden');
      } catch (error) {
        console.error('Error deleting category:', error);
        alert('Failed to delete category');
      }
    }


    async function saveCategoryValue() {
      const code = document.getElementById('modalCode').value.trim();
      const description = document.getElementById('modalDescription').value.trim();
      const sort_order = parseInt(document.getElementById('modalSort').value) || 10;

      if (!code || !description) {
        alert('Code and Description are required');
        return;
      }

      if (!moleculeId || !currentCategory) {
        alert('Molecule ID and category are required');
        return;
      }

      try {
        const data = {
          tenant_id: tenantId,
          category: currentCategory,
          code,
          description,
          sort_order
        };

        let response;
        if (editingCategoryValue) {
          // Update existing value
          response = await fetch(
            `/v1/molecules/${moleculeId}/embedded-values/${encodeURIComponent(code)}?tenant_id=${tenantId}`,
            {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            }
          );
        } else {
          // Create new value
          response = await fetch(
            `/v1/molecules/${moleculeId}/embedded-values`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            }
          );
        }

        if (!response.ok) {
          throw new Error('Failed to save value');
        }

        // Reload values and close modal
        await loadCategoryValues(currentCategory);
        closeModal();
      } catch (error) {
        console.error('Error saving category value:', error);
        alert('Failed to save value');
      }
    }

    // =====================================================
    // Save Molecule
    // =====================================================
    
    async function saveMolecule() {
      const displayWidthVal = document.getElementById('displayWidth').value;
      const type = document.getElementById('moleculeType').value;
      
      // Map UI type to new molecule_type field (S/D/R)
      let molecule_type;
      if (type === 'static') molecule_type = 'S';
      else if (type === 'dynamic') molecule_type = 'D';
      else if (type === 'reference') molecule_type = 'R';
      
      const data = {
        tenant_id: tenantId,
        molecule_key: document.getElementById('moleculeKey').value.trim(),
        label: document.getElementById('moleculeLabel').value.trim(),
        context: document.getElementById('moleculeContext').value,
        description: document.getElementById('moleculeDescription').value.trim(),
        display_width: displayWidthVal ? parseInt(displayWidthVal) : null,
        is_static: type === 'static', // Keep for backward compatibility
        molecule_type: molecule_type
      };

      if (!data.molecule_key || !data.label || !data.context) {
        alert('Please fill in all required fields');
        return;
      }

      // Collect type-specific data using new field names
      let value_kind = null;
      let value_structure = 'single';
      let scalar_type = null;
      let lookup_table_key = null;
      let ref_table_name = null;
      let ref_field_name = null;
      let ref_function_name = null;
      
      if (type === 'static') {
        const subtype = document.querySelector('input[name="staticSubtype"]:checked')?.value;
        if (subtype === 'single_value') {
          value_structure = 'single';
          value_kind = 'value';
          scalar_type = document.getElementById('staticDataType').value;
        } else if (subtype === 'embedded_list') {
          value_structure = 'embedded';
          value_kind = null; // Embedded doesn't need value_kind
        }
      } else if (type === 'dynamic') {
        const structure = document.querySelector('input[name="dynamicStructure"]:checked')?.value;
        
        if (structure === 'embedded') {
          value_structure = 'embedded';
          value_kind = null;
        } else {
          // Single value
          value_structure = 'single';
          const subtype = document.querySelector('input[name="dynamicSubtype"]:checked')?.value;
          if (subtype === 'lookup') {
            const source = document.querySelector('input[name="lookupSource"]:checked')?.value;
            if (source === 'internal') {
              value_kind = 'internal_list';
            } else if (source === 'external') {
              value_kind = 'external_list';
              lookup_table_key = document.getElementById('externalTable').value.trim();
            }
            // Get input type for lookup molecules
            data.input_type = document.getElementById('inputType').value || 'P';
          } else if (subtype === 'freeform') {
            value_kind = 'value';
            scalar_type = document.getElementById('freeformDataType').value;
            // Get decimal places for numeric types
            if (scalar_type === 'numeric') {
              data.decimal_places = parseInt(document.getElementById('decimalPlaces').value) || 0;
              data.can_be_promotion_counter = document.getElementById('canBePromotionCounter').checked;
            }
          }
        }
        
        // For dynamic molecules: set list_context
        data.list_context = document.getElementById('moleculeContext').value; // activity or member
        
        // Only collect column definitions for embedded molecules
        if (structure === 'embedded') {
          data.column_definitions = [];
          const colLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
          colLetters.forEach((letter, index) => {
            const colType = document.getElementById(`col${letter}Type`).value;
            const colDesc = document.getElementById(`col${letter}Desc`).value.trim();
            if (colType) {
              data.column_definitions.push({
                column_name: letter,
                column_type: colType,
                column_order: index + 1,
                description: colDesc
              });
            }
          });
        }
      } else if (type === 'reference') {
        value_structure = null; // References don't have structure
        const subtype = document.querySelector('input[name="referenceSubtype"]:checked')?.value;
        if (subtype === 'direct_field') {
          value_kind = 'reference';
          ref_table_name = document.getElementById('refTableName').value.trim();
          ref_field_name = document.getElementById('refFieldName').value.trim();
        } else if (subtype === 'function') {
          value_kind = 'reference';
          ref_function_name = document.getElementById('refFunctionName').value.trim();
        }
      }
      
      data.value_kind = value_kind;
      data.value_structure = value_structure;
      data.scalar_type = scalar_type;
      data.lookup_table_key = lookup_table_key;
      data.ref_table_name = ref_table_name;
      data.ref_field_name = ref_field_name;
      data.ref_function_name = ref_function_name;
      
      // Add storage configuration fields
      const storageSize = document.getElementById('storageSize').value;
      const valueType = document.getElementById('valueType').value;
      const storageTable = document.getElementById('storageTable').value;
      
      if (storageSize) data.storage_size = parseInt(storageSize);
      if (valueType) data.value_type = valueType;
      if (storageTable) data.storage_table = storageTable;

      if (!data.molecule_key || !data.label || !data.context) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const url = moleculeId ? `/v1/molecules/${moleculeId}` : '/v1/molecules';
        const method = moleculeId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          const result = await response.json();
          const savedMoleculeId = moleculeId || result.molecule_id;
          
          // If this is a static value molecule, also save the value
          if (value_kind === 'value' && scalar_type && type === 'static') {
            const valueInput = document.getElementById('staticValue');
            const scalarValue = valueInput ? valueInput.value.trim() : '';
            
            if (scalarValue) {
              try {
                // Convert value based on data type
                let typedValue = scalarValue;
                if (scalar_type === 'numeric') {
                  typedValue = parseFloat(scalarValue);
                  if (isNaN(typedValue)) {
                    alert('Invalid numeric value');
                    return;
                  }
                } else if (scalar_type === 'boolean') {
                  typedValue = scalarValue.toLowerCase() === 'true' || scalarValue === '1';
                }
                
                const valueResponse = await fetch(`/v1/molecules/${savedMoleculeId}/value`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ 
                    tenant_id: tenantId,
                    value: typedValue 
                  })
                });
                
                if (!valueResponse.ok) {
                  console.error('Failed to save scalar value');
                }
              } catch (valueError) {
                console.error('Error saving scalar value:', valueError);
              }
            }
          }
          
          // If this is an external lookup molecule, save the lookup config
          if (value_kind === 'external_list') {
            try {
              const lookupConfig = {
                tenant_id: tenantId,
                table_name: document.getElementById('externalTable').value.trim(),
                id_column: document.getElementById('externalIdColumn').value.trim(),
                code_column: document.getElementById('externalCodeColumn').value.trim(),
                label_column: document.getElementById('externalDescColumn').value.trim()
              };
              
              const lookupResponse = await fetch(`/v1/molecules/${savedMoleculeId}/lookup-config`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(lookupConfig)
              });
              
              if (!lookupResponse.ok) {
                console.error('Failed to save lookup config');
              }
            } catch (lookupError) {
              console.error('Error saving lookup config:', lookupError);
            }
          }
          
          alert('Molecule saved successfully!');
          window.location.href = 'admin_molecules.html';
        } else {
          const error = await response.json();
          alert(`Error: ${error.error || 'Failed to save molecule'}`);
        }
      } catch (error) {
        console.error('Error saving molecule:', error);
        alert('Error saving molecule: ' + error.message);
      }
    }
  </script>
</body>
</html>
