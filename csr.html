<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CSR — v1.1</title>
  <style>
    :root { --bg:#f6f7f9; --card:#fff; --ink:#111; --muted:#666; --line:#e6e9ef; --sidebar:#f2f4f7; --accent:#0b57d0; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); margin:0; color:var(--ink); }
    header { background: var(--ink); color: #fff; padding: 14px 20px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    header .brand { font-weight: 700; }
    header nav a { color:#fff; text-decoration:none; margin-left:12px; opacity:.9}
    header nav a:hover { opacity:1 }

    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

    .card { background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,.06); margin-bottom: 16px; border:1px solid var(--line); }
    .grid2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    label { display:block; font-size:12px; margin-bottom:6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d5d7db; border-radius: 10px; font-size: 14px; }
    button { background: var(--ink); color: #fff; border: 0; border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: 13px;}
    button.secondary { background:#eef2ff; color:#111; border:1px solid #d5d7db; }
    button.linky { background:transparent; color:var(--accent); border:0; padding:0; text-decoration:underline; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 8px 10px; border-bottom: 1px solid #eceff3; vertical-align: top; }
    .muted { color: var(--muted); font-size: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .pill { background:#eef2ff; color:#334; padding:2px 8px; border-radius:999px; font-size:12px; }
    .hbox { background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; }
    .error { color:#b00020; font-size:13px; margin-top:4px; }
    .reason { color:#555; font-size:12px; }
    .neg { color:#b00020; font-weight:600; }
    .right { text-align:right; }
    .section-title{font-weight:600;margin-bottom:8px}
    .badge{background:#eef2ff;border:1px solid #d5d7db;border-radius:999px;padding:3px 8px;font-size:12px}

    /* Layout for CSR Control with left sidebar */
    .control-layout{ display:grid; grid-template-columns: 260px 1fr; gap:16px; }
    .sidebar{ background:var(--sidebar); border:1px solid #e5e7eb; border-radius:12px; padding:10px; display:flex; flex-direction:column; }
    .sidehead{ font-weight:600; padding:6px 10px; margin-bottom:6px; border-bottom:1px solid #e5e7eb; }
    .sidebtn{ text-align:left; border:1px solid transparent; background:transparent; color:#111; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .sidebtn:hover{ background:#e9ecf1; border-color:#d5d7db; }
    .sidebtn.active{ background:#e6efff; border-color:#bcd1ff; color:#0b57d0; }
    .logout{ margin-top:auto; font-size:12px; color:#444; padding:8px 10px; border-top:1px solid #e5e7eb; }
    .logout a{ color:#0b57d0; text-decoration:none }
    .logout a:hover{ text-decoration:underline }

    /* Main content area placeholder */
    .mainpane{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
  </style>
</head>
<body>
  <header>
    <div class="brand">CSR Console</div>
    <nav>
      <a href="menu.html">Menu</a>
      <a href="index.html">Sign out</a>
    </nav>
  </header>

  <div class="wrap">

    <!-- Search (initial only) -->
    <div class="card">
      <div class="section-title">Search member</div>
      <div class="grid3">
        <div><label>Loyalty #</label><input id="s_loy" placeholder="e.g., 2153442807"/></div>
        <div><label>Email</label><input id="s_email" placeholder="name@example.com"/></div>
        <div><label>Phone</label><input id="s_phone" placeholder="(###) ###-####"/></div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div><label>Name (first or last)</label><input id="s_name" placeholder="Ava / Bill / etc."/></div>
        <div style="display:flex; align-items:end; gap:8px">
          <button id="doSearch">Search</button>
          <span class="muted">Tip: try loyalty <code>2153442807</code> (Bill) or <code>L12345</code> (Ava)</span>
        </div>
      </div>
      <div id="results" style="margin-top:10px"></div>
      <div id="nores" class="error" style="display:none">No member found.</div>
    </div>

    <!-- CSR Control (appears after 1 exact match) -->
    <div class="control-layout" id="csrControl" style="display:none">
      <aside class="sidebar">
        <div class="sidehead">CSR Control</div>
        <button class="sidebtn" id="nav_profile">Update Member</button>
        <button class="sidebtn" id="nav_new">New Member</button>
        <button class="sidebtn" id="nav_accruals">Accruals</button>
        <button class="sidebtn" id="nav_redemptions">Redemptions</button>
        <button class="sidebtn" id="nav_promos">Promotions</button>
        <button class="sidebtn" id="nav_aging">Point Categorization &amp; Aging</button>
        <button class="sidebtn" id="nav_tier">Tiers</button>
        <div class="logout">Signed in • <a href="index.html" onclick="sessionStorage.removeItem('auth')">Logout</a></div>
      </aside>

      <main class="mainpane">
        <!-- Member header -->
        <div class="row" style="flex-wrap:wrap; gap:10px; margin-bottom:10px">
          <div class="hbox"><strong id="h_name">—</strong></div>
          <div class="hbox">Loyalty: <span id="h_loy">—</span></div>
          <div class="hbox">Tier: <span class="pill" id="h_tier">—</span></div>
          <div class="hbox">Points: <strong id="h_pts">—</strong></div>
          <div class="hbox">Status: <span id="h_status">—</span></div>
        </div>

        <!-- Dynamic section: list/add accruals etc. -->
        <section id="content_default" class="muted">Choose an action on the left.</section>

        <!-- Accruals List -->
        <section id="pageList" style="display:none">
          <div class="row" style="justify-content:space-between; width:100%">
            <strong>Accruals</strong>
            <div class="row">
              <input id="csvFile" type="file" accept=".csv" />
              <button id="uploadCsv" class="secondary">Upload CSV</button>
              <button id="toAdd2" class="secondary">+ Add Accrual</button>
            </div>
          </div>
          <div class="muted" style="margin:8px 0 4px 0">
            CSV headers: <code>activityDate,postDate,carrier,flightNo,classBooked,classFlown,origin,dest,connecting,miles</code>
          </div>
          <div id="csvStatus" class="muted"></div>
          <table style="margin-top:8px">
            <thead><tr>
              <th>Activity</th><th>Post</th><th>Carrier</th><th>Flight</th><th>Class</th><th>From→To</th><th>Conn</th><th class="right">Miles</th><th>Action</th>
            </tr></thead>
            <tbody id="accBody"></tbody>
            <tfoot><tr><td colspan="7" class="right"><strong>Total Posted</strong></td><td class="right" id="accTotal">0</td><td></td></tr></tfoot>
          </table>
        </section>

        <!-- Add Accrual -->
        <section id="pageAdd" style="display:none">
          <div class="row" style="justify-content:space-between; width:100%">
            <strong>Add Accrual (Airline)</strong>
            <button id="backToList" class="secondary">← Back to List</button>
          </div>
          <div class="grid3" style="margin-top:10px">
            <div><label>Activity Date</label><input id="a_act" type="date"/></div>
            <div><label>Post Date</label><input id="a_post" type="date"/></div>
            <div><label>Carrier Code</label><select id="a_car"></select></div>
            <div><label>Flight Number</label><input id="a_flt" placeholder="DL456"/></div>
            <div><label>Class Booked</label><select id="a_cb"></select></div>
            <div><label>Class Flown</label><select id="a_cf"></select></div>
            <div><label>Origin</label><select id="a_org"></select></div>
            <div><label>Destination</label><select id="a_dst"></select></div>
            <div><label>Connecting Flight</label><select id="a_con"><option value="false">No</option><option value="true">Yes</option></select></div>
            <div><label>Miles</label><input id="a_mi" type="number" min="0" step="1" /></div>
          </div>
          <div class="row" style="margin-top:12px">
            <button id="saveAcc">Save Accrual</button>
            <span class="muted">Saved locally for demo.</span>
          </div>
          <div id="errBox" class="error" style="margin-top:8px"></div>
        </section>

        <!-- Simple placeholders for other menu items -->
        <section id="pageSoon" style="display:none" class="muted">Coming soon.</section>
      </main>
    </div>
  </div>

  <script>
    // ---- Auth gate ----
    if(sessionStorage.getItem('auth')!=='ok'){ location.href='index.html'; }

    const E = id => document.getElementById(id);
    const now = ()=> new Date().toISOString().slice(0,10);
    function memberKey(loy){ return 'member:'+loy; }
    function accKey(loy){ return 'accruals:'+loy; }
    function getMember(loy){ const raw = localStorage.getItem(memberKey(loy)); return raw ? JSON.parse(raw) : null; }
    function saveMember(m){ localStorage.setItem(memberKey(m.loyaltyId), JSON.stringify(m)); }
    function getAcc(loy){ return JSON.parse(localStorage.getItem(accKey(loy))||'[]'); }
    function saveAcc(loy, list){ localStorage.setItem(accKey(loy), JSON.stringify(list)); }
    function sumMiles(list){ return list.reduce((s,a)=>s + (a.miles||0), 0); }

    // ---- Seed members ----
    const seedAva = getMember('L12345') || { loyaltyId:'L12345', firstName:'Ava', lastName:'Nguyen', email:'ava@example.com', phone:'(612) 555-0101', city:'Minneapolis', state:'MN', tier:'Gold', status:'ACTIVE' };
    const seedBill = getMember('2153442807') || { loyaltyId:'2153442807', firstName:'Bill', lastName:'Jansen', email:'bill@example.com', phone:'(952) 555-0215', city:'Minneapolis', state:'MN', tier:'Platinum', status:'ACTIVE' };
    saveMember(seedAva); saveMember(seedBill);

    // Seed accruals if missing
    if(getAcc('L12345').length===0){
      saveAcc('L12345',[
        { id:'A1', type:'POST', loyaltyId:'L12345', activityDate:'2025-10-01', postDate:'2025-10-02', carrier:'DL', flightNo:'DL123', classBooked:'ECONOMY', classFlown:'ECONOMY', origin:'MSP', dest:'ATL', connecting:false, miles:905 },
        { id:'A2', type:'POST', loyaltyId:'L12345', activityDate:'2025-10-12', postDate:'2025-10-13', carrier:'DL', flightNo:'DL456', classBooked:'BUSINESS', classFlown:'BUSINESS', origin:'ATL', dest:'JFK', connecting:true, miles:760 }
      ]);
    }
    if(getAcc('2153442807').length===0){
      saveAcc('2153442807',[
        { id:'B1', type:'POST', loyaltyId:'2153442807', activityDate:'2025-09-30', postDate:'2025-10-01', carrier:'DL', flightNo:'DL789', classBooked:'ECONOMY', classFlown:'ECONOMY', origin:'MSP', dest:'JFK', connecting:false, miles:1025 }
      ]);
    }

    // ---- Lookup tables ----
    const LOOKUPS = {
      carriers: ['DL','AF','KL','KE','VS'],
      classes: ['FIRST','BUSINESS','PREMIUM_ECONOMY','ECONOMY'],
      airports: ['MSP','ATL','JFK','LAX','SFO','CDG','AMS','LHR']
    };

    // ---- State ----
    let currentLoy = null;

    // ---- UI helpers ----
    function uid(){ return 'I'+Math.random().toString(36).slice(2,9).toUpperCase(); }
    function showSection(id){
      // hide all content sections
      ['content_default','pageList','pageAdd','pageSoon'].forEach(x=> E(x).style.display='none');
      E(id).style.display='block';
      // toggle active sidebar button
      document.querySelectorAll('.sidebtn').forEach(b=> b.classList.remove('active'));
      const map = {pageList:'nav_accruals', pageAdd:'nav_accruals', pageSoon:'nav_promos'};
    }

    // ---- Search flow ----
    function drawResults(list){
      const box = E('results');
      E('nores').style.display = 'none';
      if(!list.length){ 
        box.innerHTML = '';
        E('nores').style.display = 'block';
        return; 
      }
      if(list.length === 1){
        openMember(list[0].loyaltyId);
        box.innerHTML='';
        return;
      }
      const rows = list.map(m=>`<tr>
        <td>${m.firstName||''} ${m.lastName||''}</td>
        <td><span class="badge">${m.loyaltyId}</span></td>
        <td>${m.email||''}</td>
        <td>${m.phone||''}</td>
        <td>${m.city||''}, ${m.state||''}</td>
        <td><button class="secondary sel" data-loy="${m.loyaltyId}">Open</button></td>
      </tr>`).join('');
      box.innerHTML = `<table><thead><tr><th>Name</th><th>Loyalty</th><th>Email</th><th>Phone</th><th>City/State</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
      box.querySelectorAll('.sel').forEach(btn=> btn.addEventListener('click', (e)=> openMember(e.target.getAttribute('data-loy')) ));
    }

    function doSearch(){
      const qL = (E('s_loy').value||'').trim();
      const qE = (E('s_email').value||'').trim().toLowerCase();
      const qP = (E('s_phone').value||'').replace(/\D/g,'');
      const qN = (E('s_name').value||'').trim().toLowerCase();
      const all = [getMember('L12345'), getMember('2153442807')].filter(Boolean);
      let hits = all.filter(m=>{
        const phoneDigits = (m.phone||'').replace(/\D/g,'');
        return (qL && m.loyaltyId.toLowerCase().includes(qL.toLowerCase())) ||
               (qE && (m.email||'').toLowerCase().includes(qE)) ||
               (qP && phoneDigits.includes(qP)) ||
               (qN && ((m.firstName||'').toLowerCase().includes(qN) || (m.lastName||'').toLowerCase().includes(qN)));
      });
      if(!qL && !qE && !qP && !qN){ hits = []; } // require input
      drawResults(hits);
    }

    function openMember(loy){
      currentLoy = loy;
      const m = getMember(loy); if(!m) return;
      // Show control layout
      E('csrControl').style.display='grid';
      // Fill header
      E('h_name').textContent = (m.firstName||'')+' '+(m.lastName||'');
      E('h_loy').textContent = m.loyaltyId;
      E('h_tier').textContent = m.tier || '—';
      E('h_status').textContent = m.status || '—';
      E('h_pts').textContent = sumMiles(getAcc(loy)).toLocaleString();
      // Default: show placeholder
      showOnly('content_default');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // ---- Sidebar navigation ----
    function showOnly(id){
      ['content_default','pageList','pageAdd','pageSoon'].forEach(x=> E(x).style.display='none');
      E(id).style.display='block';
      document.querySelectorAll('.sidebtn').forEach(b=> b.classList.remove('active'));
      const btnMap = {content_default:null, pageList:'nav_accruals', pageAdd:'nav_accruals', pageSoon:null};
      const toBtn = btnMap[id];
      if(toBtn){ E(toBtn).classList.add('active'); }
    }

    E('doSearch').addEventListener('click', doSearch);
    document.addEventListener('keydown', (e)=>{ 
      if(e.key==='Enter' && ['s_loy','s_email','s_phone','s_name'].includes(document.activeElement.id)){ doSearch(); } 
    });

    // Sidebar button wiring
    E('nav_accruals').addEventListener('click', ()=>{ drawList(); showOnly('pageList'); });
    E('toAdd2').addEventListener('click', ()=>{ initAddForm(); showOnly('pageAdd'); });
    E('backToList').addEventListener('click', ()=>{ drawList(); showOnly('pageList'); });

    // Placeholder routes
    const soon = ()=> showOnly('pageSoon');
    E('nav_profile').addEventListener('click', soon);
    E('nav_new').addEventListener('click', soon);
    E('nav_redemptions').addEventListener('click', soon);
    E('nav_promos').addEventListener('click', soon);
    E('nav_aging').addEventListener('click', soon);
    E('nav_tier').addEventListener('click', soon);

    // Accrual list
    function drawList(){
      const body = E('accBody'); if(!body || !currentLoy) return;
      const list = getAcc(currentLoy);
      body.innerHTML='';
      list.forEach(a=>{
        const tr = document.createElement('tr');
        const milesCell = a.miles < 0 ? `<span class="neg">${a.miles.toLocaleString()}</span>` : a.miles.toLocaleString();
        const reason = a.type==='REVERSAL' ? `<div class="reason">Reversal of ${a.refId} — ${a.reason||'No reason given'}</div>` : '';
        const action = a.type==='POST' ? `<button class="linky" data-id="${a.id}">Reverse</button>` : '';
        tr.innerHTML = `<td>${a.activityDate||''}</td><td>${a.postDate||''}</td><td>${a.carrier||''}</td><td>${a.flightNo||''}</td>
                        <td>${a.classFlown || a.classBooked || ''}</td><td>${a.origin||''}→${a.dest||''}</td>
                        <td>${a.connecting?'Y':'N'}</td><td class="right">${milesCell}${reason}</td><td>${action}</td>`;
        if(action){ tr.querySelector('button').addEventListener('click', ()=> handleReverse(a.id)); }
        body.appendChild(tr);
      });
      E('accTotal').textContent = sumMiles(list).toLocaleString();
      const m = getMember(currentLoy); if(m){ E('h_pts').textContent = sumMiles(list).toLocaleString(); }
    }

    // Add page setup
    function fillSelect(sel, arr){ sel.innerHTML = arr.map(x=>`<option>${x}</option>`).join(''); }
    function initAddForm(){
      fillSelect(E('a_car'), LOOKUPS.carriers);
      fillSelect(E('a_cb'), LOOKUPS.classes);
      fillSelect(E('a_cf'), LOOKUPS.classes);
      fillSelect(E('a_org'), LOOKUPS.airports);
      fillSelect(E('a_dst'), LOOKUPS.airports);
      E('a_post').value = now();
      E('a_act').value = now();
      E('errBox').textContent = '';
      E('a_flt').value=''; E('a_mi').value='';
    }

    function validateAcc(a){
      const errs = [];
      ['activityDate','postDate','carrier','flightNo','classBooked','classFlown','origin','dest'].forEach(k=>{ if(!a[k]) errs.push(k); });
      if(!a.miles || a.miles < 0) errs.push('miles');
      const flightOk = /^[A-Z]{2}\d{1,4}$/.test(a.flightNo);
      if(!flightOk) errs.push('flight format');
      if(flightOk){
        const prefix = a.flightNo.slice(0,2);
        if(prefix !== a.carrier) errs.push('carrier/flight mismatch');
      }
      if(a.origin && a.dest && a.origin === a.dest) errs.push('origin≠destination');
      return errs;
    }

    // Save accrual
    E('saveAcc').addEventListener('click', ()=>{
      if(!currentLoy){ alert('No member selected'); return; }
      const a = {
        id: uid(),
        type:'POST',
        loyaltyId: currentLoy,
        activityDate: E('a_act').value,
        postDate: E('a_post').value,
        carrier: E('a_car').value,
        flightNo: (E('a_flt').value||'').trim().toUpperCase(),
        classBooked: E('a_cb').value,
        classFlown: E('a_cf').value,
        origin: E('a_org').value,
        dest: E('a_dst').value,
        connecting: E('a_con').value === 'true',
        miles: parseInt(E('a_mi').value || '0', 10)
      };
      const errs = validateAcc(a);
      if(errs.length){
        E('errBox').textContent = 'Please fix: '+errs.join(', ');
        return;
      }
      const list = getAcc(currentLoy); list.push(a); saveAcc(currentLoy, list);
      drawList(); showOnly('pageList');
    });

    // Reverse logic
    function handleReverse(id){
      const list = getAcc(currentLoy);
      const orig = list.find(x=>x.id===id);
      if(!orig){ alert('Original accrual not found.'); return; }
      const already = list.find(x=>x.type==='REVERSAL' && x.refId===id);
      if(already){ alert('This accrual is already reversed.'); return; }
      const reason = prompt('Enter reversal reason (required):');
      if(!reason || !reason.trim()){ alert('Reversal reason is required.'); return; }
      const rev = {
        id: uid(),
        type:'REVERSAL',
        refId: orig.id,
        loyaltyId: orig.loyaltyId,
        activityDate: orig.activityDate,
        postDate: now(),
        carrier: orig.carrier,
        flightNo: orig.flightNo,
        classBooked: orig.classBooked,
        classFlown: orig.classFlown,
        origin: orig.origin,
        dest: orig.dest,
        connecting: orig.connecting,
        miles: -Math.abs(orig.miles),
        reason: reason.trim()
      };
      list.push(rev); saveAcc(currentLoy, list);
      drawList();
    }
  </script>
</body>
</html>
